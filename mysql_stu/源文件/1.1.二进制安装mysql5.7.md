[TOC]

mysql的官方文档翻译版："https://www.docs4dev.com/docs/zh/mysql/5.7/reference/preface.html"。

# 二进制安装MySQL 5.7
## 1.检测当前系统上是否安装mariadb-server或其他版本的mysql

```
shell> rpm -q mariadb-server
shell> rpm -q mariadb
shell> rpm -q mysql
```

## 2.检测系统初始化环境并创建mysql用户和mysql组

```
shell> getenforce
shell> systemctl status firewalld
shell> iptables -L -n
shell> groupadd -r mysql
shell> useradd -r -g mysql -s /bin/false -d /usr/local/mysql mysql
```

## 3.下载软件包并创建数据目录和日志目录

```
shell> wget http://172.16.100.2/source_code_package/mysql/mysql-5.7.17-linux-glibc2.5-x86_64.tar.gz -P /tmp
shell> md5sum /tmp/mysql-5.7.17-linux-glibc2.5-x86_64.tar.gz
shell> mkdir -pv /database/mysql5.7/{data,binlogs,run,logs,undologs,redologs}
shell> chown -r mysql.mysql /database/mysql5.7
```

## 4.创建配置文件

```
shell> /etc/my.cnf
shell> cat >> /etc/my.cnf << EOF
    [client]
    socket=/database/mysql5.7/run/mysqld.sock
    [mysqld]

    ########basic settings########
    server-id = 11
    port = 3306
    user = mysql
    bind_address = 172.16.200.12
    pid-file=/database/mysql5.7/run/mysql.pid
    autocommit = 0
    character_set_server=utf8mb4
    skip_name_resolve = 1
    max_connections = 800
    max_connect_errors = 1000
    datadir = /database/mysql5.7/data
    transaction_isolation = READ-COMMITTED
    explicit_defaults_for_timestamp = 1
    join_buffer_size = 128M
    tmp_table_size = 64M
    tmpdir = /tmp
    max_allowed_packet = 16M
    sql_mode = "STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER"
    interactive_timeout = 1800
    wait_timeout = 1800
    read_buffer_size = 16M
    read_rnd_buffer_size = 32M
    sort_buffer_size = 32M

    ########log settings########
    log_error = /database/mysql5.7/logs/mysql.err
    slow_query_log = 1
    slow_query_log_file =  /database/mysql5.7/logs/mysql.slow
    log_queries_not_using_indexes = 1
    log_slow_admin_statements = 1
    log_slow_slave_statements = 1
    log_throttle_queries_not_using_indexes = 10
    expire_logs_days = 90
    long_query_time = 2
    min_examined_row_limit = 100

    ########replication settings########
    master_info_repository = TABLE
    relay_log_info_repository = TABLE
    log_bin =  /database/mysql5.7/binlogs/master
    sync_binlog = 1
    gtid_mode = on
    enforce_gtid_consistency = 1
    log_slave_updates
    binlog_format = row
    relay_log = /database/mysql5.7/binlogs/slave
    relay_log_recovery = 1
    binlog_gtid_simple_recovery = 1
    slave_skip_errors = ddl_exist_errors

    ########innodb settings########
    innodb_page_size = 8192
    innodb_buffer_pool_size = 1G
    innodb_buffer_pool_instances = 8
    innodb_buffer_pool_load_at_startup = 1
    innodb_buffer_pool_dump_at_shutdown = 1
    innodb_lru_scan_depth = 2000
    innodb_lock_wait_timeout = 5
    innodb_io_capacity = 4000
    innodb_io_capacity_max = 8000
    innodb_flush_method = O_DIRECT
    innodb_file_format = Barracuda
    innodb_file_format_max = Barracuda
    innodb_log_group_home_dir = /database/mysql5.7/undologs
    innodb_undo_logs = 128
    innodb_undo_tablespaces = 3
    innodb_flush_neighbors = 1
    innodb_log_file_size = 1G
    innodb_log_buffer_size = 16M
    innodb_purge_threads = 4
    innodb_large_prefix = 1
    innodb_thread_concurrency = 64
    innodb_print_all_deadlocks = 1
    innodb_strict_mode = 1
    innodb_sort_buffer_size = 64M

    ########semi sync replication settings########
    plugin_dir=/usr/local/mysql/lib/plugin
    plugin_load = "rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"
    loose_rpl_semi_sync_master_enabled = 1
    loose_rpl_semi_sync_slave_enabled = 1
    loose_rpl_semi_sync_master_timeout = 5000

    [mysqld-5.7]
    innodb_buffer_pool_dump_pct = 40
    innodb_page_cleaners = 4
    innodb_undo_log_truncate = 1
    innodb_max_undo_log_size = 2G
    innodb_purge_rseg_truncate_frequency = 128
    binlog_gtid_simple_recovery=1
    log_timestamps=system
    transaction_write_set_extraction=MURMUR32
    show_compatibility_56=on

    [mysqld_safe]
    socket=/database/mysql5.7/run/mysqld.sock
    EOF
```

MySQL支持使用类似于“[mysqld-5.7]”的方式定义特定版本所独有的配置参数，从而在一个配置文件中定义多个版本的数据库的配置。

MySQL配置文件的读取顺序详见2.1章。

## 5.解压指定软件包并开始安装

```
shell> tar axf /tmp/mysql-5.7.17-linux-glibc2.5-x86_64.tar.gz -C /usr/local
shell> cd /usr/local/
shell> ln -s mysql-5.7.17-linux-glibc2.5-x86_64 mysql
shell> bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/database/mysql5.7/data
shell> bin/mysql_ssl_rsa_setup --datadir=/database/mysql5.7/data
```

通过mysqld命令进行初始化时可使用“mysqld --verbose --help | less”命令查看可使用的选项。

## 6.安装后操作

```
shell> cat >> /etc/systemd/system/mysqld.service << EOF
    [Unit]
    Description=MySQL database server
    Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
    After=syslog.target
    After=network.target

    [Service]
    Type=simple
    User=mysql
    Group=mysql
    ExecStart=/usr/local/mysql/bin/mysqld_safe --defaults-file=/etc/my.cnf

    [Install]
    WantedBy=multi-user.target
    EOF
shell> echo 'export PATH=/usr/local/mysql/bin:$PATH' >> /etc/profile.d/mysql.sh
shell> source /etc/profile.d/mysql.sh
shell> chown -R mysql:mysql /usr/local/mysql /mysql
shell> chown -R mysql.mysql /database/mysql5.7
```

## 7.导出库文件和头文件

```
shell> ln -s /usr/local/mysql/include /usr/include/mysql
shell> echo "/usr/local/mysql/lib" >> /etc/ld.so.conf.d/mysql.conf
shell> ldconfig
shell> ldconfig -p | grep mysql
```

## 8.修改初始密码

**mysql初始化后密码保存在错误日志中**

```
shell> mysql -uroot -hlocalhost -p
mysql> SET PASSWORD="redhat";
mysql> FLUSH PRIVILEGES;
```

**注意：在mysql5.7.29之后要求使用'alter user'的命令修改密码，如："ALTER USER USER() IDENTIFIED BY '123456';"。**

## 9.对特殊数据库开启角色功能

注意跨互联网的用户的必需使用ssl。

## 10.对特殊数据库开启审计功能

