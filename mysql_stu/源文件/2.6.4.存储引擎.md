[TOC]

# 概述

1. 用来处理数据库的相关CRUD（C：create、R：Read、U：update、D：Delete）操作。
2. 每个数据库都有存储引擎的概念。
3. Oracle数据库（不同类型的表即为不同的存储引擎），堆表、簇表和索引组织表即分别对应不同的存储引擎。

如果将数据库分为两层，上层即为SQL解析器、优化器，下层即为存储引擎以管理底层数据文件。

## 存储引擎介绍

知名存储引擎：

* Aria：是MariaDB的一个全新的存储引擎，它是作为MyISAM存储引擎的替代者而开发的，具有自动恢复的功能，比MyISAM更好的缓存系统，相对于MyISAM有一定提升。
* WiredTiger：MongoDB使用的即为该存储引擎。

mysql官方存储引擎：

* InnoDB：支持事务、行级锁和外键，而其他存储引擎已经不再维护和开发。
* MyISAM：对多核CPU的利用率非常差。
* Memory：使用存储在内存中的内容来创建表。
* Federated：FEDERATED引擎创建的表只是在本地有表定义文件，数据文件则存在于远程数据库中。
* CSV：以csv格式进行数据存储，所有列不能为NuLL，不支持索引、不适合大表、不舍和在线处理。
* Archive：这个存储引擎基本上用于数据归档，压缩比非常的高，存储空间大概是innodb的10-15分之一，由于它不支持索引同时也不能缓存索引和数据，所以它不适合作为并发访问表的存储引擎。
* Performance_Schema：主要用于收集数据库服务器性能参数，用户是不能创建存储引擎为PERFORMANCE_SCHEMA的表。
* BloackHole：类似于Linux文件系统中的/dev/null是一个虚拟设备。
* Mrg_MyISAM：也被称为merge存储引擎。

第三方存储引擎：

* TokuDB：插入密集型，该存储引擎的读取的性能较差。
* InfoBright：OLAP（Online AnalyticalProcessing，在线分析处理）场景，社区版本有数据量的限制，主要用于列存。
* Spider： Spider是为MySQL/MariaDB开发的一个特殊引擎，具有内嵌分片功能，主要功能是将数据分散到多个后端节点，它的作用类似于一个代理。

# 存储引擎相关操作

## 查看当前数据库支持的存储引擎

```
mysql> show engines;
*************************** 1. row ***************************
      Engine: MRG_MYISAM
     Support: YES
     Comment: Collection of identical MyISAM tables
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 2. row ***************************
      Engine: CSV
     Support: YES
     Comment: CSV storage engine
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 3. row ***************************
      Engine: MyISAM
     Support: YES
     Comment: MyISAM storage engine
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 4. row ***************************
      Engine: BLACKHOLE
     Support: YES
     Comment: /dev/null storage engine (anything you write to it disappears)
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 5. row ***************************
      Engine: PERFORMANCE_SCHEMA
     Support: YES
     Comment: Performance Schema
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 6. row ***************************
      Engine: InnoDB
     Support: DEFAULT
     Comment: Supports transactions, row-level locking, and foreign keys
Transactions: YES
          XA: YES
  Savepoints: YES
*************************** 7. row ***************************
      Engine: ARCHIVE
     Support: YES
     Comment: Archive storage engine
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 8. row ***************************
      Engine: MEMORY
     Support: YES
     Comment: Hash based, stored in memory, useful for temporary tables
Transactions: NO
          XA: NO
  Savepoints: NO
*************************** 9. row ***************************
      Engine: FEDERATED
     Support: NO
     Comment: Federated MySQL storage engine
Transactions: NULL
          XA: NULL
  Savepoints: NULL
```

 Support字段表示当前数据库实例是否支持该存储引擎，在该字段显示为“YES”表示支持，显示为“NO”表示不支持，显示为“DEFAULT”表示支持且已设置为默认存储引擎。 



查看设置默认存储引擎：

```
mysql> show variables like "%default%engine%";
+----------------------------+--------+
| Variable_name              | Value  |
+----------------------------+--------+
| default_storage_engine     | InnoDB |
| default_tmp_storage_engine | InnoDB |
+----------------------------+--------+

mysql> set default_tmp_storage_engine=myisam;
mysql> show variables like "%default%engine%";
+----------------------------+--------+
| Variable_name              | Value  |
+----------------------------+--------+
| default_storage_engine     | InnoDB |
| default_tmp_storage_engine | MyISAM |
+----------------------------+--------+
```



禁用存储引擎：

* --skip-archive：在启动时指定可用于关闭archive存储引擎。
* --skip-blackhole：在启动时指定可用于关闭blackhole存储引擎。

# 存储引擎简介

## MyISAM

1. MySQL 5.1版本之前的的默认存储引擎。
2. 多核CPU的优化很差。
3. 堆表数据结构。
4. 表锁设计。
5. 支持数据静态压缩。
6. 不支持事务。
7. 数据容易丢失。
8. 索引容易损坏。
9. 唯一的优点是数据文件可以直接拷贝至另一服务器使用。

长时间使用后或者系统crash后myi文件中的内容和myd文件中的内容不一致，则需要定期修表（myisamchk和repair），其修表的过程实际上是删除myi文件，通过myd文件重建myi文件。

## CSV存储引擎

1. CSV即Comma-Separated Values，是一种标准文件格式。
2. 文件以纯文本形式存储表格数据。
3. 不支持特殊字符。
4. 使用广泛。
5. 通过MySQL CSV存储引擎创建了一个CSV格式的表即创建了一个CSV格式的文件。
6. 可通过MySQL标准接口来查看和修改CSV文件。
7. 无需将CSV文件导入到数据库。
8. CSV存储引擎表每个列必须是NOT NULL属性。

mysql中slow_log和general_log就是CSV存储引擎的表。

```
mysql> show create table slow_log\G
*************************** 1. row ***************************
       Table: slow_log
Create Table: CREATE TABLE `slow_log` (
  `start_time` timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
  `user_host` mediumtext NOT NULL,
  `query_time` time(6) NOT NULL,
  `lock_time` time(6) NOT NULL,
  `rows_sent` int(11) NOT NULL,
  `rows_examined` int(11) NOT NULL,
  `db` varchar(512) NOT NULL,
  `last_insert_id` int(11) NOT NULL,
  `insert_id` int(11) NOT NULL,
  `server_id` int(10) unsigned NOT NULL,
  `sql_text` mediumblob NOT NULL,
  `thread_id` bigint(21) unsigned NOT NULL
) ENGINE=CSV DEFAULT CHARSET=utf8 COMMENT='Slow log'
mysql> select * from slow_log limit 2\G
*************************** 1. row ***************************
    start_time: 2020-03-21 16:18:27.653314
     user_host: root[root] @ localhost []
    query_time: 00:00:03.000364
     lock_time: 00:00:00.000000
     rows_sent: 1
 rows_examined: 0
            db: mysql
last_insert_id: 0
     insert_id: 0
     server_id: 200314190
      sql_text: select sleep(3)
     thread_id: 87
*************************** 2. row ***************************
    start_time: 2020-03-21 16:18:34.685368
     user_host: root[root] @ localhost []
    query_time: 00:00:00.000410
     lock_time: 00:00:00.000170
     rows_sent: 1
 rows_examined: 1
            db: mysql
last_insert_id: 0
     insert_id: 0
     server_id: 200314190
      sql_text: select * from slow_log
     thread_id: 87

shell> cat /db/mysql/data/mysql/slow_log.CSV 
"2020-03-21 16:18:27.653314","root[root] @ localhost []","00:00:03.000364","00:00:00.000000",1,0,"mysql",0,0,200314190,"select sleep(3)",87
"2020-03-21 16:18:34.685368","root[root] @ localhost []","00:00:00.000410","00:00:00.000170",1,1,"mysql",0,0,200314190,"select * from slow_log",87
"2020-03-21 16:18:38.856413","root[root] @ localhost []","00:00:00.000479","00:00:00.000182",2,2,"mysql",0,0,200314190,"select * from slow_log",87
"2020-03-21 16:18:56.635902","root[root] @ localhost []","00:00:00.000559","00:00:00.000207",3,3,"mysql",0,0,200314190,"select * from slow_log",87
```

## Federated存储引擎

1. 允许本地访问远程MySQL数据库中表的数据。
2. 本地不存储任何数据文件。
3. 类似于Oracle DBlink，仅支持MySQL ==> MySQL的访问，不支持异构数据库的访问。
4. Federated存储引擎默认不开启（如需启用Federated存储引擎则需要在配置文件的[mysqld]字段下定义federated重启即可）。
5. MariaDB在FederatedX存储引擎支持异构数据库远程访问。

### 创建一个使用Federated存储引擎的表

远程数据库连接字符串：

```
scheme://USER_NAME[:PASSWORD]@host_name[:PORT]/db_name/tb_name 

CONNECTION='mysql://USER_NAME[:PASSWORD]@host_name[:PORT]/db_name/tb_name'
```

创建Federated表：

```
CREATE TABLE tb_name (
    COL1 NOT NULL,
    COL2 ...
) ENGINE=FEDERATE
CONNECTION="MYSQL://USER_NAME:PASSWORD@HOST:PORT/DB_NAME/TB_NAME";
```

### 示例



DB1：

```
mysql> CREATE USER "tuser01"@"%" IDENTIFIED BY "redhat";
mysql> GRANT SELECT ON test56.t1 TO "tuser01"@"%";
mysql> FLUSH PRIVILEGES;
mysql> CREATE TABLE t1
    -> (id int(3) not null primary key auto_increment,
    -> name varchar(40) not null)
    -> ENGINE=InnoDB AUTO_INCREMENT=0;
mysql> INSERT INTO test56.t1 (name) VALUES ("tom") ,("jerry"), ("jim");
mysql> SELECT * FROM test56.t1;
+----+-------+
| id | name  |
+----+-------+
|  1 | tom   |
|  2 | jerry |
|  3 | jim   |
+----+-------+
```

DB2：

```
shell> vim /etc/my.cnf
		......
		[mysqld]
		......
		federated
		......
shell> systemctl restart mysqld

mysql> SHOW ENGINES;
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |
| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |
| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |
| BLACKHOLE          | NO      | /dev/null storage engine (anything you write to it disappears) | NULL         | NULL | NULL       |
| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |
| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |
| ARCHIVE            | NO      | Archive storage engine                                         | NULL         | NULL | NULL       |
| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |
| FEDERATED          | YES     | Federated MySQL storage engine                                 | NO           | NO   | NO         |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
mysql> CREATE DATABASE IF NOT EXISTS test1;
mysql> CREATE TABLE fed_t1 
    -> (id int(3) not null primary key auto_increment,
    -> name varchar(40) not null)
    -> ENGINE=Federated 
    -> CONNECTION="MYSQL://tuser01:redhat@192.168.3.55/test56/t1";
mysql> SELECT * FROM fed_t1;
+----+-------+
| id | name  |
+----+-------+
|  1 | tom   |
|  2 | jerry |
|  3 | jim   |
+----+-------+
```

