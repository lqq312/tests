[TOC]

# 概述

SSL：Secure Socket Layer，是维护Client - Server之间加密通讯的一套安全协议。

不使用SSL则会导致通信的数据包为明文传输：

```
shell1> tcpdump -i ens32 -s0 -nn -vvv -A tcp dst port 3306 and dst host 192.168.3.190 >> /tmp/dump3306.txt

shell2> mysql --login-path=local_master
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| TESTDB             |
| mysql              |
| performance_schema |
| sys                |
| test_db            |
+--------------------+
mysql> select * from test_db.tb0;
+----+
| id |
+----+
|  1 |
|  2 |
|  3 |
+----+

shell1> cat /tmp/dump3306.txt
14:24:19.311832 IP (tos 0x0, ttl 64, id 55719, offset 0, flags [DF], proto TCP (6), length 77)
    192.168.3.193.51972 > 192.168.3.190.3306: Flags [P.], cksum 0xaf5f (correct), seq 2327071466:2327071491, ack 2051150477, win 7300, options [nop,nop,TS val 702364699 ecr 709677811], length 25
E..M..@.@..3..............J.zB......._.....
).<.*L..............select user()
14:24:19.312727 IP (tos 0x0, ttl 64, id 55720, offset 0, flags [DF], proto TCP (6), length 52)
    192.168.3.193.51972 > 192.168.3.190.3306: Flags [.], cksum 0xd3d2 (correct), seq 25, ack 87, win 7300, options [nop,nop,TS val 702364700 ecr 709767811], length 0
E..4..@.@..K..............K.zB.............
).<.*N2.
14:24:28.878470 IP (tos 0x0, ttl 64, id 396, offset 0, flags [DF], proto TCP (6), length 52)
    192.168.3.191.47114 > 192.168.3.190.3306: Flags [.], cksum 0x7206 (correct), seq 3756378081, ack 1764415917, win 237, options [nop,nop,TS val 709762794 ecr 709777377], length 0
E..4..@.@..j.........
......i*......r......
*N..*NW.
14:24:28.878549 IP (tos 0x0, ttl 64, id 16042, offset 0, flags [DF], proto TCP (6), length 52)
```

明文的SQL会被抓包并解析出原SQL。

# 在MySQL5.7上启用SSL

1. 授权一个用户必需使用SSL会话连接到服务器

```
mysql> create user 'jim'@'%' identified by 'admin' require ssl;
mysql> select * from mysql.user where user="jim"\G
*************************** 1. row ***************************
                  Host: %
                  User: jim
           Select_priv: N
           Insert_priv: N
           Update_priv: N
           Delete_priv: N
           Create_priv: N
             Drop_priv: N
           Reload_priv: N
         Shutdown_priv: N
          Process_priv: N
             File_priv: N
            Grant_priv: N
       References_priv: N
            Index_priv: N
            Alter_priv: N
          Show_db_priv: N
            Super_priv: N
 Create_tmp_table_priv: N
      Lock_tables_priv: N
          Execute_priv: N
       Repl_slave_priv: N
      Repl_client_priv: N
      Create_view_priv: N
        Show_view_priv: N
   Create_routine_priv: N
    Alter_routine_priv: N
      Create_user_priv: N
            Event_priv: N
          Trigger_priv: N
Create_tablespace_priv: N
              ssl_type: ANY
            ssl_cipher: 
           x509_issuer: 
          x509_subject: 
         max_questions: 0
           max_updates: 0
       max_connections: 0
  max_user_connections: 0
                plugin: mysql_native_password
 authentication_string: *4ACFE3202A5FF5CF467898FC58AAB1D615029441
      password_expired: N
 password_last_changed: 2020-03-23 11:55:02
     password_lifetime: NULL
        account_locked: N
```

2. 测试该用户分别启用和禁用ssl连接至服务器

```
shell> mysql -ujim -h127.0.0.1 -P 3331  -padmin --ssl-mode=DISABLED

shell> mysql -ujim -h127.0.0.1 -P 3331  -padmin --ssl-mode=REQUIRE
mysql> \s
--------------
mysql  Ver 14.14 Distrib 5.7.28, for linux-glibc2.12 (x86_64) using  EditLine wrapper

Connection id:          8
Current database:
Current user:           jim@127.0.0.1
SSL:                    Cipher in use is ECDHE-RSA-AES128-GCM-SHA256
Current pager:          stdout
Using outfile:          ''
Using delimiter:        ;
Server version:         5.7.28-log MySQL Community Server (GPL)
Protocol version:       10
Connection:             127.0.0.1 via TCP/IP
Server characterset:    utf8mb4
Db     characterset:    utf8mb4
Client characterset:    utf8
Conn.  characterset:    utf8
TCP port:               3331
Uptime:                 19 min 53 sec

Threads: 2  Questions: 21  Slow queries: 0  Opens: 124  Flush tables: 1  Open tables: 39  Queries per second avg: 0.017
```

3. 测试一个用户并未授权使用ssl的模式是否能连接至服务器

```
mysql> create user 'tom'@"%" identified by "tom";
mysql> select * from mysql.user where user="tom"\G
*************************** 1. row ***************************
                  Host: %
                  User: tom
           Select_priv: N
           Insert_priv: N
           Update_priv: N
           Delete_priv: N
           Create_priv: N
             Drop_priv: N
           Reload_priv: N
         Shutdown_priv: N
          Process_priv: N
             File_priv: N
            Grant_priv: N
       References_priv: N
            Index_priv: N
            Alter_priv: N
          Show_db_priv: N
            Super_priv: N
 Create_tmp_table_priv: N
      Lock_tables_priv: N
          Execute_priv: N
       Repl_slave_priv: N
      Repl_client_priv: N
      Create_view_priv: N
        Show_view_priv: N
   Create_routine_priv: N
    Alter_routine_priv: N
      Create_user_priv: N
            Event_priv: N
          Trigger_priv: N
Create_tablespace_priv: N
              ssl_type: 
            ssl_cipher: 
           x509_issuer: 
          x509_subject: 
         max_questions: 0
           max_updates: 0
       max_connections: 0
  max_user_connections: 0
                plugin: mysql_native_password
 authentication_string: *71FF744436C7EA1B954F6276121DB5D2BF68FC07
      password_expired: N
 password_last_changed: 2020-03-23 12:05:41
     password_lifetime: NULL
        account_locked: N

shell> mysql -utom -h127.0.0.1 -P 3331 -ptom --ssl-mode=DISABLED
shell> mysql -utom -h127.0.0.1 -P 3331 -ptom --ssl-mode=REQUIRE
```

**当创建用户时未指定“REQUIRE SSL”，无论这个用户是否使用ssl会话模式都可以连接到服务。**

## 使用预共享密钥连接至服务器

1. 创建授权用户

```
mysql> create user 'jerry'@'%' identified by 'jerry' require x509;
mysql> select * from mysql.user where user='jerry'\G
*************************** 1. row ***************************
                  Host: %
                  User: jerry
           Select_priv: N
           Insert_priv: N
           Update_priv: N
           Delete_priv: N
           Create_priv: N
             Drop_priv: N
           Reload_priv: N
         Shutdown_priv: N
          Process_priv: N
             File_priv: N
            Grant_priv: N
       References_priv: N
            Index_priv: N
            Alter_priv: N
          Show_db_priv: N
            Super_priv: N
 Create_tmp_table_priv: N
      Lock_tables_priv: N
          Execute_priv: N
       Repl_slave_priv: N
      Repl_client_priv: N
      Create_view_priv: N
        Show_view_priv: N
   Create_routine_priv: N
    Alter_routine_priv: N
      Create_user_priv: N
            Event_priv: N
          Trigger_priv: N
Create_tablespace_priv: N
              ssl_type: X509
            ssl_cipher: 
           x509_issuer: 
          x509_subject: 
         max_questions: 0
           max_updates: 0
       max_connections: 0
  max_user_connections: 0
                plugin: mysql_native_password
 authentication_string: *09FB9E6E2AA0750E9D8A8D22B6AA8D86C85BF3D0
      password_expired: N
 password_last_changed: 2020-03-23 12:09:59
     password_lifetime: NULL
        account_locked: N
mysql> flush privileges;
```

2. 测试用户连接

```
shell> mysql -ujerry -h127.0.0.1 -P 3331  -pjerry --ssl-cert=/multi_db/mysql1/data/client-cert.pem --ssl-key=/multi_db/mysql1/data/client-key.pem
mysql> \s
--------------
mysql  Ver 14.14 Distrib 5.7.28, for linux-glibc2.12 (x86_64) using  EditLine wrapper

Connection id:          18
Current database:
Current user:           jerry@127.0.0.1
SSL:                    Cipher in use is ECDHE-RSA-AES128-GCM-SHA256
Current pager:          stdout
Using outfile:          ''
Using delimiter:        ;
Server version:         5.7.28-log MySQL Community Server (GPL)
Protocol version:       10
Connection:             127.0.0.1 via TCP/IP
Server characterset:    utf8mb4
Db     characterset:    utf8mb4
Client characterset:    utf8
Conn.  characterset:    utf8
TCP port:               3331
Uptime:                 36 min 19 sec

Threads: 2  Questions: 44  Slow queries: 0  Opens: 124  Flush tables: 1  Open tables: 39  Queries per second avg: 0.020
```

