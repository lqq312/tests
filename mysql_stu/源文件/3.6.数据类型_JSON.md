[TOC]

# 概述

1. MySQL 5.7版本将Json替换BLOB类型，实现原生支持Json。
2. 在MySQL原生支持Json之前如需将Json数据插入至关系型数据库，就需要在数据库中定义一个BLOB类型的列，在应用程序上将数年据转换成Json格式，然后再插入。但如果使用这种方式会有如下三种缺陷：
   * 无法对JSON数据的有效性进行检查：BLOB类型无法的数据库层实现约束性检查。
   * 查询不需要遍历所有字符串才能找到的数据。
   * 仅支持部分属性索引，通过虚拟列的功能可以对JSON中的部分数据进行索引。

## 创建一个JSON列的表并插入数据

```
mysql> CREATE TABLE t8 (
    -> id INT NOT NULL auto_increment PRIMARY KEY,
    -> DATA json NOT NULL 
    -> ) ENGINE = INNODB;
mysql> desc t8;
+-------+---------+------+-----+---------+----------------+
| Field | Type    | Null | Key | Default | Extra          |
+-------+---------+------+-----+---------+----------------+
| id    | int(11) | NO   | PRI | NULL    | auto_increment |
| data  | json    | NO   |     | NULL    |                |
+-------+---------+------+-----+---------+----------------+
mysql> INSERT INTO t8 
    -> VALUE
    -> ( NULL, '{"name":"David","mail":"david@beadlwallet.com","age":"20","address":"XXXX road XXX "}' );
mysql> INSERT INTO t8 
    -> VALUE
    -> ( NULL, '{"name":"Tom","mail":"tom@beadlwallet.com","age":"22","address":"YYYY road yyy "}' );
mysql> select * from t8;
+----+--------------------------------------------------------------------------------------+
| id | data                                                                                 |
+----+--------------------------------------------------------------------------------------+
|  1 | {"age": "20", "mail": "david@abc.com", "name": "David", "address": "XXXX road XXX "} |
|  2 | {"age": "22", "mail": "tom@abc.com", "name": "Tom", "address": "YYYY road yyy "}     |
+----+--------------------------------------------------------------------------------------+

```

## 查询JSON字段中某个“Field”的值

使用JSON_EXTRACT(json_doc, path[, path] ...)函数可实现JSON字段的查询。

```
mysql> SELECT * FROM t8;
+----+--------------------------------------------------------------------------------------+
| id | data                                                                                 |
+----+--------------------------------------------------------------------------------------+
|  1 | {"age": "20", "mail": "david@abc.com", "name": "David", "address": "XXXX road XXX "} |
|  2 | {"age": "22", "mail": "tom@abc.com", "name": "Tom", "address": "YYYY road yyy "}     |
+----+--------------------------------------------------------------------------------------+
mysql> SELECT
    -> json_extract( DATA, '$.name', '$.age' ) 
    -> FROM
    -> t8;
+-------------------------------------+
| json_extract(data,'$.name','$.age') |
+-------------------------------------+
| ["David", "20"]                     |
| ["Tom", "22"]                       |
+-------------------------------------+
```

## 在JSON字段中新增一个“Field”和对应的“Value”

使用JSON_INSERT(json_doc, field, val[, field, val] ...)可实现新增JSON文档的Field，但如果新增的Field已存在则新的Value不会覆盖原有的Value。

```
mysql> UPDATE t8 
    -> SET DATA = JSON_INSERT( DATA, "$.name", "Jim", "$.PhoneNum", "13123456789" ) 
    -> WHERE
    -> id = 2;
mysql> select * from t8;
+----+-------------------------------------------------------------------------------------------------------------+
| id | data                                                                                                        |
+----+-------------------------------------------------------------------------------------------------------------+
|  1 | {"age": "20", "mail": "david@abc.com", "name": "David", "address": "XXXX road XXX "}                        |
|  2 | {"age": "22", "mail": "tom@abc.com", "name": "Tom", "address": "YYYY road yyy ", "PhoneNum": "13123456789"} |
+----+-------------------------------------------------------------------------------------------------------------+
```

此处JSON文档中的“PhoneNum”已插入为一个新的字段，而原有的“name”的字段的值也没有改变。

## 为JSON字段创建索引

为JSON类型的数据创建列时必须创建一个虚拟列，然后为这个虚拟列创建索引；也可以在通过JSON字段创建一个实际存储的列，然后再在这个实际存储的列上创建索引（虚拟列无法创建全文索引，而实际存储的列是可以创建索引的）。

### 通过创建虚拟列为JSON字段创建索引

虚拟列并不占用实际在存储空间，因此会在每次查询时通过CPU进行计算得出。在虚拟列上无法创建全文索引。

语法：

```
mysql> ALTER TABLE tb_name ADD COLUMN column_name COLUMN_TYPE GENERATED ALWAYS AS (JSON_EXTRACT(json_column,'$.key')) VIRTUAL;

mysql> ALTER TABLE tb_name ADD INDEX index_name (json_virt_column);
```

注意：此处的“COLUMN_TYPE”仅表示数据类型且不能跟其他的修饰符。

示例：

```
mysql> select * from t8;
+----+-------------------------------------------------------------------------------------------------------------+
| id | data                                                                                                        |
+----+-------------------------------------------------------------------------------------------------------------+
|  1 | {"age": "20", "mail": "david@abc.com", "name": "David", "address": "XXXX road XXX "}                        |
|  2 | {"age": "22", "mail": "tom@abc.com", "name": "Tom", "address": "YYYY road yyy ", "PhoneNum": "13123456789"} |
+----+-------------------------------------------------------------------------------------------------------------+
mysql> ALTER TABLE t8 ADD COLUMN user_name VARCHAR ( 50 ) generated always AS (
    -> json_extract( DATA, "$.name" )) virtual;
mysql> select * from t8;
+----+-------------------------------------------------------------------------------------------------------------+-----------+
| id | data                                                                                                        | user_name |
+----+-------------------------------------------------------------------------------------------------------------+-----------+
|  1 | {"age": "20", "mail": "david@abc.com", "name": "David", "address": "XXXX road XXX "}                        | "David"   |
|  2 | {"age": "22", "mail": "tom@abc.com", "name": "Tom", "address": "YYYY road yyy ", "PhoneNum": "13123456789"} | "Tom"     |
+----+-------------------------------------------------------------------------------------------------------------+-----------+
mysql> ALTER TABLE t8 ADD INDEX NAME ( user_name );
mysql> show create table t8\G
*************************** 1. row ***************************
       Table: t8
Create Table: CREATE TABLE `t8` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `data` json NOT NULL,
  `user_name` varchar(50) GENERATED ALWAYS AS (json_extract(`data`,'$.name')) VIRTUAL,
  PRIMARY KEY (`id`),
  KEY `NAME` (`user_name`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4

mysql> INSERT INTO t8 ( id, DATA )
    -> VALUES
    -> ( NULL, '{"name":"Jim","age":"21","mail":"jim@abc.com","address":"xxxx road yyyy"}' );
mysql> select * from t8;
+----+-------------------------------------------------------------------------------------------------------------+-----------+
| id | data                                                                                                        | user_name |
+----+-------------------------------------------------------------------------------------------------------------+-----------+
|  1 | {"age": "20", "mail": "david@abc.com", "name": "David", "address": "XXXX road XXX "}                        | "David"   |
|  2 | {"age": "22", "mail": "tom@abc.com", "name": "Tom", "address": "YYYY road yyy ", "PhoneNum": "13123456789"} | "Tom"     |
|  3 | {"age": "21", "mail": "jim@abc.com", "name": "Jim", "address": "xxxx road yyyy"}                            | "Jim"     |
+----+-------------------------------------------------------------------------------------------------------------+-----------+
```

### 通过创建实际存储的列为JSON字段创建索引

语法：

```
mysql> ALTER TABLE tb_name ADD COLUMN column_name COLUMN_TYPE GENERATED ALWAYS AS (JSON_EXTRACT(json_column,'$.key')) STORED;

mysql> ALTER TABLE tb_name ADD FULLINDEX INDEX index_fulltext_name (name_stored);
```

示例：

```
mysql> ALTER TABLE t8 ADD COLUMN user_name VARCHAR ( 50 ) generated always AS (
    -> json_extract( DATA, "$.name" )) stored;
mysql> select * from t8;
+----+---------------------------------------------------------------------------------------------------------------------+-----------+
| id | data                                                                                                                | user_name |
+----+---------------------------------------------------------------------------------------------------------------------+-----------+
|  1 | {"age": "20", "mail": "david@beadlwallet.com", "name": "David", "address": "XXXX road XXX "}                        | "David"   |
|  2 | {"age": "22", "mail": "tom@beadlwallet.com", "name": "Tom", "address": "YYYY road yyy ", "PhoneNum": "13123456789"} | "Tom"     |
|  3 | {"age": "21", "mail": "jim@abc.com", "name": "Jim", "address": "xxxx road yyyy"}                                    | "Jim"     |
+----+---------------------------------------------------------------------------------------------------------------------+-----------+
mysql> show create table t8\G
*************************** 1. row ***************************
       Table: t8
Create Table: CREATE TABLE `t8` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `data` json NOT NULL,
  `user_name` varchar(50) GENERATED ALWAYS AS (json_extract(`DATA`,'$.name')) STORED,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4

mysql> INSERT INTO t8 ( DATA ) 
    -> VALUE
    -> ( '{"name":"lily","email":"lily@abc.com","age":24,"address":"wuhan"}' );
mysql> select * from t8;
+----+---------------------------------------------------------------------------------------------------------------------+-----------+
| id | data                                                                                                                | user_name |
+----+---------------------------------------------------------------------------------------------------------------------+-----------+
|  1 | {"age": "20", "mail": "david@beadlwallet.com", "name": "David", "address": "XXXX road XXX "}                        | "David"   |
|  2 | {"age": "22", "mail": "tom@beadlwallet.com", "name": "Tom", "address": "YYYY road yyy ", "PhoneNum": "13123456789"} | "Tom"     |
|  3 | {"age": "21", "mail": "jim@abc.com", "name": "Jim", "address": "xxxx road yyyy"}                                    | "Jim"     |
|  4 | {"age": 24, "name": "lily", "email": "lily@abc.com", "address": "wuhan"}                                            | "lily"    |
+----+---------------------------------------------------------------------------------------------------------------------+-----------+
```

## 修改JSON字段内指定Field的Value

