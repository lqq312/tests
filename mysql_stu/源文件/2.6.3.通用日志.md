[TOC]

# 概述

1. 可以记录数据库所有相关的操作。
2. 同样可以将日志保存到表。
3. 开启后性能下降明显。

在某些时候需要抓取特定的SQL，而这条SQL的执行时间很短，此时可使用“general_log”进行debug，或者开启“general_log”以实现审计的功能，MySQL的Ente rprise版本中就提供了Audit的插件，该审计的插件与general_log类似，但粒度更细，并且general_log是同步，但官方的审计插件是异步的，性能更好。

## 通用日志相关参数

* general_log：定义是否开启通用日志（bool值），建议关闭。
* general_log_file：指定通用日志的文件名及保存路径，其默认的文件名为“机器名.log”。
* log_output：定义通用日志保存的方式，其值为“FILE”、“TABLE”或“NONE”，如保存为“TABLE”其表名为“mysql.general_log”。

# 通过通用日志实现审计

MySQL Commnuite版本身不支持审计功能，但可通过安装其他的版本的MySQL的插件以实现记录服务器活动，记录谁连接到服务器，运行了什么查询，访问了哪些表，能存储到日志文件或发送到本地syslogd守护进程。例如：Mariadb、Percona或Mcafee。

## 安装Mariadb的审计插件

Mariadb提供的审计插件名为“server_audit.so”，该文件一般存放于Mariadb二进制安装包的lib/plugin目录下，可将该文件拷贝至mysql的plugin目录下。

安装步骤如下：

```
mysql> select @@plugin_dir;
+------------------------------+
| @@plugin_dir                 |
+------------------------------+
| /usr/local/mysql/lib/plugin/ |
+------------------------------+
mysql> exit

# wget -P /root http://local-yum.ycigilink.local/Softwares/mysql/mysql-plugin/mariadb-10.5.1-audit-plugin.tar.gz
# tar axf /root/mariadb-10.5.1-audit-plugin.tar.gz -C /usr/local/mysql/lib/plugin/
# chmod 755 /usr/local/mysql/lib/plugin/server_audit.so
# chown mysql.mysql /usr/local/mysql/lib/plugin/server_audit.so

mysql> INSTALL PLUGIN server_audit SONAME 'server_audit.so';
mysql> SHOW VARIABLES LIKE "server_audit%";
+-------------------------------+-----------------------+
| Variable_name                 | Value                 |
+-------------------------------+-----------------------+
| server_audit_events           |                       |
| server_audit_excl_users       |                       |
| server_audit_file_path        | server_audit.log      |
| server_audit_file_rotate_now  | OFF                   |
| server_audit_file_rotate_size | 1000000               |
| server_audit_file_rotations   | 9                     |
| server_audit_incl_users       |                       |
| server_audit_loc_info         |                       |
| server_audit_logging          | OFF                   |
| server_audit_mode             | 1                     |
| server_audit_output_type      | file                  |
| server_audit_query_log_limit  | 1024                  |
| server_audit_syslog_facility  | LOG_USER              |
| server_audit_syslog_ident     | mysql-server_auditing |
| server_audit_syslog_info      |                       |
| server_audit_syslog_priority  | LOG_INFO              |
+-------------------------------+-----------------------+
```

### 配置并使用Mariadb的审计插件

* server_audit_logging：bool值，定义是否开启审计日志的功能，如需开启建议在配置文件中指定；

* server_audit_events：定义哪些类型的事件会被记录。

  > 1. CONNECT：用于记录连接、断开连接和失败的连接——包括错误代码；
  > 2. QUERY：用于记录执行的查询及其结果为纯文本格式，包括由于语法或权限错误而导致的查询失败；
  > 3. TABLE：记录受查询执行影响的表；
  > 4. QUERY_DDL：与QUERY类似，仅记录DDL类型的查询（如：`CREATE`、`ALTER`、`DROP`、`RENAME`和`TRUNCATE`语句，但`CREATE/DROP [PROCEDURE/FUNCTION/USER]`和`RENAME USER`除外）。
  > 5. QUERY_DML：与QUERY类似，仅记录DML类型的查询（如：`DO`、`CALL`、`LOAD DATA/XML`、`DELETE`、`INSERT`、`SELECT`、`UPDATE`、`HANDLER`和`REPLACE`语句）。
  > 6. QUERY_DML_NO_SELECT：与QUERY_DML类似，但不记录SELECT查询（如：`DO`、`CALL`、`LOAD DATA/XML`、`DELETE`、`INSERT`、`UPDATE`、`HANDLER`和`REPLACE`语句仍会被记录）。
  > 7. QUERY_DCL：与QUERY类似，但仅记录DCL类型的SQL（如：`CREATE USER`, `DROP USER`, `RENAME USER`, `GRANT`, `REVOKE` and `SET PASSWORD`语句）

* server_audit_file_rotate_now：审计日志是否立即轮转；
* server_audit_file_rotate_size：设置单个审计日志的大小；
* server_audit_file_rotations：指定审计日志的数量，如设置为0则日志从不轮转；
* server_audit_output_type：定义审计日志是保存在file中还是syslog中；
* server_audit_syslog_facility：如审计日志保存的syslog中则需要在此处定义接收日志的facility；
* server_audit_syslog_ident：定义日志记录在syslog时为审计日志内容打上的tag，默认为“mysql-server_auditing”；
* server_audit_syslog_info：指定的info字符串将添加到syslog记录；
* server_audit_syslog_priority：定义审计日志记录到系统日志的哪个级别；
* server_audit_excl_users：定义在此处的用户的操作不会被记录到审计日志中；
* server_audit_incl_users：定义的此处的用户的操作会被记录到审计日志即便该用户已定义在“server_audit_excl_users”变量中；
* server_audit_file_path：如“server_audit_output_type”定义为file，则需要在此处定义审计日志保存的路径和文件名；
* server_audit_loc_info：在早期的版本中是一个只读变量，对用户无意义；
* server_audit_mode：其值主要反映了启动插件所使用的服务器版本，供开发人员用于测试，对用户无意义；
* server_audit_query_log_limit：定义审计日志中查询字符串的长度限制。

示例：记录root用户的管理操作、连接和DML相关操作，审计日志保存到/db/mysql/logs目录下，文件名为mariadb_audit.log，并开启日志轮转。

```
mysql> set global server_audit_file_path="/db/mysql/logs/mariadb_audit.log";
mysql> set global server_audit_incl_users="root";
mysql> set global server_audit_events="CONNECT,QUERY_DCL,QUERY_DML"; 
mysql> \r
Connection id:    14
Current database: mysql
mysql> show variables like "server_audit%";
+-------------------------------+----------------------------------+
| Variable_name                 | Value                            |
+-------------------------------+----------------------------------+
| server_audit_events           | CONNECT,QUERY_DML,QUERY_DCL      |
| server_audit_excl_users       |                                  |
| server_audit_file_path        | /db/mysql/logs/mariadb_audit.log |
| server_audit_file_rotate_now  | OFF                              |
| server_audit_file_rotate_size | 1000000                          |
| server_audit_file_rotations   | 9                                |
| server_audit_incl_users       | root                             |
| server_audit_loc_info         |                                  |
| server_audit_logging          | OFF                              |
| server_audit_mode             | 1                                |
| server_audit_output_type      | file                             |
| server_audit_query_log_limit  | 1024                             |
| server_audit_syslog_facility  | LOG_USER                         |
| server_audit_syslog_ident     | mysql-server_auditing            |
| server_audit_syslog_info      |                                  |
| server_audit_syslog_priority  | LOG_INFO                         |
+-------------------------------+----------------------------------+

shell> cat /db/mysql/logs/mariadb_audit.log
20200321 23:53:33,test0.ycigilink.local,root,localhost,16,0,DISCONNECT,,,0
20200321 23:53:33,test0.ycigilink.local,root,localhost,17,0,CONNECT,,,0
20200321 23:56:48,test0.ycigilink.local,root,localhost,17,532,QUERY,,'GRANT UPDATE ON `test_db`.* TO \'dev_user\'@\'192.168.3.%\'',0
```