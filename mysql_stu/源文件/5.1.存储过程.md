[TOC]

# 概述

* 存储在数据库端的一组SQL语句集；
* 用户可以通过存储过程名和传参多次调用的程序模块；
* 存储过程的特点：
  * 使用灵活，可以使用流控制语句、自定义变量等完成复杂的业务逻辑；
  * 提高数据安全性，屏蔽应用程序对表的操作，易于进行审计；
  * 减少网络传输；
  * 提高代码维护的复杂度，实际使用中要评估场景是否适合。

# 流控制语句

参照官方文档“SQL Statement Syntax”--> “MySQL Compound-Statement Syntax”--> “Flow Control Statements”即13.6.5章。

## IF

```
CASE
	WHEN search_condition THEN statement_list
	[WHEN search_condition THEN statement_list] ...
	[ELSE statement_list]
END CASE
```



## CASE

```
CASE case_value
	WHEN when_value THEN statement_list
	[WHEN when_value THEN statement_list] ...
	[ELSE statement_list]
END CASE

CASE
	WHEN search_condition THEN statement_list
	[WHEN search_condition THEN statement_list] ...
	[ELSE statement_list]
END CASE
```



## WHILE

```
WHILE search_condition DO statement_list
END WHILE
```



## REPEAT

```
REPEAT statement_list
UNTIL search_condition
END REPEAT
```

# 存储过程——语法

```
CREATE
	[DEFINER = {user | CURRENT_USER}]
	PROCEDURE sp_name ([proc_parameter[,...]])
	[characteristic ...] routine_body

proc_parameter:
	[IN | OUT | INOUT] param_name type

type:
	Any valid MySQL data type

characteristic:
	COMMENT 'string'
	| [NOT] DETERMINISTIC

routine_body:
	Valid SQL routine statement
```



# 示例——存储过程的调用

```
DELIMITER //
CREATE PROCEDURE proc_test1(IN total INT, OUT res INT)
BEGIN
	DECLARE i INT;
	SET i = 1;
	SET res = 1;
	IF total <= 0 THEN
		SET total = 1;
	END IF;
	WHILE i <= total DO
		SET res = res*i;
		INSERT INTO tbl_proc_test(num) VALUES(res);
		SET i = i+1'
	END WHILE;
END //
DELIMITER ;


mysql> SET @total=10;
mysql> SET @res=1;
mysql> CALL proc_test(@total,@res);
mysql> select @res;
```



