1. 工具安装

   ```
   shell> yum -y install perl-Data-Dumper perl-Digest-MD5 perl-DBD-MySQL perl-Compress-Raw-Bzip2 perl-Compress-Raw-Zlib perl-DBI perl-Digest perl-IO-Compress perl-IO-Socket-IP perl-IO-Socket-SSL perl-Mozilla-CA perl-Net-Daemon perl-Net-LibIDN perl-Net-SSLeay perl-PlRPC perl-TermReadKey rsync
   shell> set +H
   shell> wget http://local-yum.ycigilink.local/Softwares/mysql/percona-tools/percona-toolkit-3.2.1_x86_64.tar.gz
   shell> tar axf percona-toolkit-3.2.1_x86_64.tar.gz -C /usr/local/
   shell> cd /usr/local
   shell> ln -sv percona-toolkit-3.2.1/ percona-toolkit
   shell> echo 'export PATH="/usr/local/percona-toolkit/bin":${PATH}' >> /etc/profile.d/percona-toolkit.sh
   shell> source /etc/profile.d/percona-toolkit.sh
   ```

2. 主从库授权

   ```
   (master)mysql> create user "CheckSum"@"10.167.1.%" identified by "CheckSum";
   (master)mysql> grant all on *.* to "CheckSum"@"10.167.1.%";
   (master)mysql> flush privileges;
   
   (slave1)mysql> create user "CheckSum"@"10.167.1.%" identified by "CheckSum";
   (slave1)mysql> grant all on *.* to "CheckSum"@"10.167.1.%";
   (slave1)mysql> flush privileges;
   
   (slave2)mysql> create user "CheckSum"@"10.167.1.%" identified by "CheckSum";
   (slave2)mysql> grant all on *.* to "CheckSum"@"10.167.1.%";
   (slave2)mysql> flush privileges;
   ```

   

3. 工具校验

   在执行主从一致性校验时会在主库的服务器上创建一个新库，一般会命名为perconat，因此在部署mysql主从时除了复制指定库外，建议另外指定一个测试库用于主从同步的测试。

   ```
   (master)shell> vim /etc/my.cnf
   		binlog_do_db = c5web
   		binlog_do_db = testdb
   
   (slave1)shell> vim /etc/my.cnf
   		replicate_do_db = c5web
   		replicate_do_db = testdb
   
   (slave2)shell> vim /etc/my.cnf
   		replicate_do_db = c5web
   		replicate_do_db = testdb
   
   shell> set +H
   shell> pt-table-checksum --nocheck-binlog-format --nocheck-plan --nocheck-replication-filters --replicate=testdb.checksums --set-vars innodb_lock_wait_timeout=120 --databases "c5web" -u"CheckSum" -h"10.167.1.61" -p"CheckSum" >> /tmp/checksum.log 
   
   Checking if all tables can be checksummed ...
   Starting checksum ...
               TS ERRORS  DIFFS     ROWS  DIFF_ROWS  CHUNKS SKIPPED    TIME TABLE
   09-17T14:07:37      0      0    16557          0       4       0   0.105 c5web.a_alarm_org_hour
   09-17T14:07:37      0      0   102362          0       1       0   0.581 c5web.a_alarm_vehicle_day
   09-17T14:07:37      0      0       86          0       1       0   0.026 c5web.a_alarmtype
   09-17T14:07:37      0      0        0          0       1       0   0.026 c5web.a_area_alarm
   09-17T14:07:37      0      0        0          0       1       0   0.027 c5web.a_area_alarm_rule
   ```

   TS：完成检查的时间；

   ERRORS：检查时发生错误和警告的数量；

   DIFFS：0表示一致，1表示不一致。当指定“--no-replicate-check”时会一直为0，当指定“--replicate-check-only”时会显示不同的信息；

   ROWS：检查的行数；

   CHUNKS：被划分到表中的块的数量；

   SKIPPED：由于错误或警告过大，则跳过的块的数量；

   TIME：校验这个表所消耗的时长；

   TABLE：被检查的表名。

