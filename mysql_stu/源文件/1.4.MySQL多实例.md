[TOC]

# 概述

1. 一台服务器上安装多个MySQL实例。
2. 充分利用硬件资源。
3. 通过mysqld_multi程序即可。

## 多实例安装注意事项

1. port、datadir和socket必须分别指定，每个实例一个独有的配置。

   > 注意：如共用同一个配置文件，在“[mysqld]”下定义的配置会继承给所有其他的实例，而在实例中定义的配置会替换公共的配置中的定义。

2. mysql多实例可分别配置其配置文件，也可以单独指定配置文件即每实例一个配置文件。

# 多实例配置方案

## 共享配置文件的多实例方案

1. 环境准备

```
shell> groupadd -r mysql
shell> useradd -r -g mysql -s /sbin/nologin -d /usr/local/mysql mysql
shell> id mysql
		uid=996(mysql) gid=994(mysql) groups=994(mysql)
shell> wget -P /root http://local-yum.ycigilink.local/Softwares/mysql/mysql-community-server/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz
shell> tar axf /root/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz -C /usr/local
shell> cd /usr/local
shell> ln -sv mysql-5.7.28-linux-glibc2.12-x86_64/ mysql
shell> chown -R mysql.mysql ./mysql*
shell> mkdir -pv /multi_db/{mysql1,mysql2,mysql3,mysql4}/{data,run,logs,undologs,binlogs,redologs,tmp}
shell> chown -R mysql.mysql /multi_db/mysql*
```

2. 创建共享配置文件

```
shell> vim /etc/my.cnf
    [client]
    default_character_set=utf8mb4

    [mysqld]
    character_set_server=utf8mb4
    user = mysql
    skip_name_resolve = 1
    explicit_defaults_for_timestamp = 1
    sql_mode = "STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER"
    interactive_timeout = 1800
    wait_timeout = 1800
    log_queries_not_using_indexes = 1
    log_slow_admin_statements = 1
    log_slow_slave_statements = 1
    log_throttle_queries_not_using_indexes = 10
    expire_logs_days = 90
    long_query_time = 2
    min_examined_row_limit = 100
    plugin_dir=/usr/local/mysql/lib/plugin
    plugin_load = "rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"
    loose_rpl_semi_sync_master_enabled = 1
    loose_rpl_semi_sync_slave_enabled = 1
    loose_rpl_semi_sync_master_timeout = 5000
    basedir=/usr/local/mysql

    [mysqld_multi]
    mysqld=/usr/local/mysql/bin/mysqld_safe
    mysqladmin=/usr/local/mysql/bin/mysqladmin
    log=/multi_db/multi_db.log

    [mysqld1]
    datadir=/multi_db/mysql1/data
    port=3331
    socket=/multi_db/mysql1/run/mysql1.sock
    pid_file=/multi_db/mysql1/run/mysql1.pid
    log_error=/multi_db/mysql1/logs/mysql1.err
    slow_query_log = 1
    slow_query_log_file = /multi_db/mysql1/logs/mysql.slow
    user=mysql
    server_id=11
    performance_schema=0
    innodb_buffer_pool_size=32M
    bind_address=0.0.0.0
    skip_name_resolve=1
    max_connections = 65535
    max_connect_errors = 1000
    join_buffer_size = 128M
    tmp_table_size = 64M
    tmpdir = /multi_db/mysql1/tmp
    max_allowed_packet = 256M
    read_buffer_size = 16M
    read_rnd_buffer_size = 32M
    sort_buffer_size = 32M

    [mysqld2]
    datadir=/multi_db/mysql2/data
    port=3332
    socket=/multi_db/mysql2/run/mysql2.sock
    pid_file=/multi_db/mysql2/run/mysql2.pid
    log_error=/multi_db/mysql2/logs/mysql2.err
    slow_query_log = 1
    slow_query_log_file = /multi_db/mysql2/logs/mysql.slow
    user=mysql
    server_id=21
    performance_schema=0
    innodb_buffer_pool_size=32M
    bind_address=0.0.0.0
    skip_name_resolve=1
    max_connections = 65535
    max_connect_errors = 1000
    join_buffer_size = 128M
    tmp_table_size = 64M
    tmpdir = /multi_db/mysql2/tmp
    max_allowed_packet = 256M
    read_buffer_size = 16M
    read_rnd_buffer_size = 32M
    sort_buffer_size = 32M

    [mysqld3]
    datadir=/multi_db/mysql3/data
    port=3333
    socket=/multi_db/mysql3/run/mysql3.sock
    pid_file=/multi_db/mysql3/run/mysql3.pid
    log_error=/multi_db/mysql3/logs/mysql3.err
    slow_query_log = 1
    slow_query_log_file = /multi_db/mysql3/logs/mysql.slow
    user=mysql
    server_id=31
    performance_schema=0
    innodb_buffer_pool_size=32M
    bind_address=0.0.0.0
    skip_name_resolve=1
    max_connections = 65535
    max_connect_errors = 1000
    join_buffer_size = 128M
    tmp_table_size = 64M
    tmpdir = /multi_db/mysql3/tmp
    max_allowed_packet = 256M
    read_buffer_size = 16M
    read_rnd_buffer_size = 32M
    sort_buffer_size = 32M

    [mysqld4]
    datadir=/multi_db/mysql4/data
    port=3334
    socket=/multi_db/mysql4/run/mysql4.sock
    pid_file=/multi_db/mysql4/run/mysql4.pid
    log_error=/multi_db/mysql4/logs/mysql4.err
    slow_query_log = 1
    slow_query_log_file = /multi_db/mysql4/logs/mysql.slow
    user=mysql
    server_id=41
    performance_schema=0
    innodb_buffer_pool_size=32M
    bind_address=0.0.0.0
    skip_name_resolve=1
    max_connections = 65535
    max_connect_errors = 1000
    join_buffer_size = 128M
    tmp_table_size = 64M
    tmpdir = /multi_db/mysql4/tmp
    max_allowed_packet = 256M
    read_buffer_size = 16M
    read_rnd_buffer_size = 32M
    sort_buffer_size = 32M

    [mysql]
    prompt=(\\U) [\\d]>\\_
    default_character_set=utf8mb4
shell> echo "export PATH=/usr/local/mysql/bin:$PATH" > /etc/profile.d/mysqld.sh
shell> source /etc/profile.d/mysqld.sh
shell> touch /multi_db/mysql1/logs/mysql1.err
shell> touch /multi_db/mysql2/logs/mysql2.err
shell> touch /multi_db/mysql3/logs/mysql3.err
shell> touch /multi_db/mysql4/logs/mysql4.err
shell> chown -R mysql.mysql /multi_db/mysql*
```

3. 启动多实例的mysql并通过mysqld_multi进行管理

```
shell> mysqld_multi start 1
shell> mysqld_multi report
    Reporting MySQL servers
    MySQL server from group: mysqld1 is running
    MySQL server from group: mysqld2 is not running
    MySQL server from group: mysqld3 is not running
    MySQL server from group: mysqld4 is not running
shell> mysql -uroot -hlocalhost -S /multi_db/mysql1/run/mysql1.sock -p

mysql> set password = "ycig1234";
mysql> flush privileges;
mysql> exit

shell> vim /root/.my.cnf
		[client]
		user=root
		password=ycig1234
shell> mysqld_multi stop 1
shell> mysqld_multi report
    Reporting MySQL servers
    MySQL server from group: mysqld1 is not running
    MySQL server from group: mysqld2 is not running
    MySQL server from group: mysqld3 is not running
    MySQL server from group: mysqld4 is not running
```

## 独享配置文件的多实例方案

1. 环境准备

```
shell> groupadd -r mysql
shell> useradd -r -g mysql -s /sbin/nologin -d /usr/local/mysql mysql
shell> id mysql
		uid=996(mysql) gid=994(mysql) groups=994(mysql)
shell> wget -P /root http://local-yum.ycigilink.local/Softwares/mysql/mysql-community-server/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz
shell> tar axf /root/mysql-5.7.28-linux-glibc2.12-x86_64.tar.gz -C /usr/local
shell> cd /usr/local
shell> ln -sv mysql-5.7.28-linux-glibc2.12-x86_64/ mysql
shell> chown -R mysql.mysql ./mysql*
shell> mkdir -pv /multi_db/{mysql1,mysql2,mysql3,mysql4}/{data,run,logs,undologs,binlogs,redologs,tmp}
shell> chown -R mysql.mysql /multi_db/mysql*
```

2. 为多个实例的mysql创建其独有的配置文件并初始化（以mysql1为例）

```
shell> vim /multi_db/mysql1/my.cnf
    [client]
    socket=/multi_db/mysql1/run/mysqld.sock
    default_character_set=utf8mb4

    [mysqld]
    ########basic settings########
    server-id = 200314190
    port = 3331
    user = mysql
    pid-file=/multi_db/mysql1/run/mysql.pid
    character_set_server=utf8mb4
    #character_set_connection=utf8mb4
    #character_set_results=utf8mb4
    skip_name_resolve = 1
    max_connections = 65535
    max_connect_errors = 1000
    datadir = /multi_db/mysql1/data
    explicit_defaults_for_timestamp = 1
    join_buffer_size = 128M
    tmp_table_size = 64M
    tmpdir = /multi_db/mysql1/tmp
    max_allowed_packet = 256M
    sql_mode = "STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER"
    interactive_timeout = 1800
    wait_timeout = 1800
    read_buffer_size = 16M
    read_rnd_buffer_size = 32M
    sort_buffer_size = 32M

    federated

    ########log settings########
    log_error = /multi_db/mysql1/logs/mysql.err
    slow_query_log = 1
    slow_query_log_file =  /multi_db/mysql1/logs/mysql.slow
    log_queries_not_using_indexes = 1
    log_slow_admin_statements = 1
    log_slow_slave_statements = 1
    log_throttle_queries_not_using_indexes = 10
    expire_logs_days = 90
    long_query_time = 2
    min_examined_row_limit = 100

    ########replication settings########
    master_info_repository = TABLE
    #relay_log_info_repository = TABLE
    log_bin =  /multi_db/mysql1/binlogs/master
    sync_binlog = 1
    gtid_mode = on
    enforce_gtid_consistency = 1
    log_slave_updates
    binlog_format = row 
    #relay_log = /multi_db/mysql1/binlogs/slave
    #relay_log_recovery = 1
    binlog_gtid_simple_recovery = 1
    slave_skip_errors = ddl_exist_errors

    binlog_ignore_db = mysql
    binlog_ignore_db = sys
    binlog_ignore_db = information_schema
    binlog_ignore_db = performance_schema

    ########innodb settings########
    innodb_page_size = 8192
    innodb_buffer_pool_size = 1G
    innodb_buffer_pool_instances = 8
    innodb_buffer_pool_load_at_startup = 1
    innodb_buffer_pool_dump_at_shutdown = 1
    innodb_lru_scan_depth = 2000
    innodb_lock_wait_timeout = 5
    innodb_io_capacity = 4000
    innodb_io_capacity_max = 8000
    innodb_flush_method = O_DIRECT
    innodb_file_format = Barracuda
    innodb_file_format_max = Barracuda
    innodb_log_group_home_dir = /multi_db/mysql1/undologs
    innodb_undo_logs = 128
    innodb_undo_tablespaces = 3
    innodb_flush_neighbors = 1
    innodb_log_file_size = 1G
    innodb_log_buffer_size = 16M
    innodb_purge_threads = 4
    innodb_large_prefix = 1
    innodb_thread_concurrency = 64
    innodb_print_all_deadlocks = 1
    innodb_strict_mode = 1
    innodb_sort_buffer_size = 64M 

    ########semi sync replication settings########
    plugin_dir=/usr/local/mysql/lib/plugin
    plugin_load = "rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"
    loose_rpl_semi_sync_master_enabled = 1
    loose_rpl_semi_sync_slave_enabled = 1
    loose_rpl_semi_sync_master_timeout = 5000

    [mysqld-5.7]
    innodb_buffer_pool_dump_pct = 40
    innodb_page_cleaners = 4
    innodb_undo_log_truncate = 1
    innodb_max_undo_log_size = 2G
    innodb_purge_rseg_truncate_frequency = 128
    binlog_gtid_simple_recovery=1
    log_timestamps=system
    transaction_write_set_extraction=MURMUR32
    show_compatibility_56=on

    [mysqld_safe]
    socket=/multi_db/mysql1/run/mysqld.sock

    [mysql]
    prompt=(\\U) [\\d]>\\_
    default_character_set=utf8mb4
shell> vim /etc/systemd/system/mysqld1.service
		[Unit]
    Description=MySQL database server 
    After=syslog.target
    After=network.target

    [Service]
    Type=simple
    User=mysql
    Group=mysql
    ExecStart=/usr/local/mysql/bin/mysqld_safe --defaults-file=/multi_db/mysql1/my.cnf --skip-archive --skip-blackhole

    [Install]
    WantedBy=multi-user.target
shell> systemctl daemon-reload
shell> mysqld --defaults-file=./my.cnf --initialize --user=mysql --basedir=/usr/local/mysql
shell> systemctl start mysqld1/service
```

