[TOC]

# 查看库和表的详情

## 查看指定库内表的行数

```
mysql> select `table_name`, `table_type`, `data_length`, `table_rows`, `table_comment`
    -> from tables
    -> where table_schema = "c5web"
    ->   and table_rows != 0
    -> order by table_rows desc;
+----------------------------+------------+-------------+------------+-----------------------------------------------+
| table_name                 | table_type | data_length | table_rows | table_comment                                 |
+----------------------------+------------+-------------+------------+-----------------------------------------------+
| r_vehicle_status           | BASE TABLE |   386924544 |    2810653 |                                               |
| n_alarm_info               | BASE TABLE |   461373440 |    1832408 | 报警信息表                                    |
| r_org_status               | BASE TABLE |    31023104 |     362602 | 机构实时信息统计                              |
| t_siminfo                  | BASE TABLE |     3694592 |      22925 | SimInfo:SIM卡                                 |
...........
| s_instruct_record          | BASE TABLE |        8192 |          3 | 809指令执行记录表                             |
| d_contract_info            | BASE TABLE |        8192 |          2 |                                               |
| d_cont_vehicle             | BASE TABLE |        8192 |          2 |                                               |
+----------------------------+------------+-------------+------------+-----------------------------------------------+
59 rows in set (0.02 sec)
```

## 查看库的大小

```
######################## 查看库的大小 ########################
mysql> select sum(DATA_LENGTH) + sum(INDEX_LENGTH) from information_schema.TABLES where TABLE_SCHEMA="c5web";
+--------------------------------------+
| sum(DATA_LENGTH) + sum(INDEX_LENGTH) |
+--------------------------------------+
|                           2138685440 |
+--------------------------------------+
1 row in set (0.02 sec)

######################## 计算库的大小（结果的单位为GB） ########################
mysql> select 2138685440 /1024 / 1024 /1024;
+-------------------------------+
| 2138685440 /1024 / 1024 /1024 |
+-------------------------------+
|                1.991806030273 |
+-------------------------------+
1 row in set (0.00 sec)
```



## 查看表的大小

```
######################## 查看表的大小 ########################
mysql> select table_name,data_length+index_length,table_rows from information_schema.tables where table_schema="t1" and table_name="t_siminfo";
+------------+--------------------------+------------+
| table_name | data_length+index_length | table_rows |
+------------+--------------------------+------------+
| t_siminfo  |                  2359296 |      10860 |
+------------+--------------------------+------------+
1 row in set (0.00 sec)

######################## 计算表的大小（结果单位为MB） ########################
mysql> select 2359296 / 1024/ 1024;
+----------------------+
| 2359296 / 1024/ 1024 |
+----------------------+
|           2.25000000 |
+----------------------+
```

# 计算InnoDB每分钟的写入量

```
mysql> pager grep sequence
PAGER set to 'grep sequence'
mysql> show engine innodb status\G select sleep(60); show engine innodb status\G
Log sequence number 20113557149
1 row in set (0.00 sec)

1 row in set (1 min 0.00 sec)

Log sequence number 20113840556
1 row in set (0.00 sec)

mysql> nopager
PAGER set to stdout
mysql>select (20113840556 - 20113557149) / 1024 /1024 as MB_per_min;
+------------+
| MB_per_min |
+------------+
| 0.27027798 |
+------------+
1 row in set (0.00 sec)

mysql> select ((20113840556 - 20113557149) / 1024 /1024) * 60 as MB_per_hour;
+-------------+
| MB_per_hour |
+-------------+
| 16.21667862 |
+-------------+
1 row in set (0.00 sec)
```

由此可计算出当前数据库每分钟的数据写入量为0.27MB，每小时的数据写入量为16.21MB，一般建议innodb_log_file_size的大小设置为半小时的数据写入量，由此可得出该数据库服务器的innodb_log_file_size建议设置为8MB。

# 查看指定库内的存储过程和函数

## 查看数据库内的存储过程和函数

```
# 查看指定库内的存储过程
mysql> select * from mysql.proc where db="c5web" and type="procedure"\G
*************************** 1. row ***************************
                  db: c5web
                name: pro_org_change
                type: PROCEDURE
       specific_name: pro_org_change
            language: SQL
     sql_data_access: CONTAINS_SQL
    is_deterministic: NO
       security_type: DEFINER
          param_list: IN orgCode VARCHAR(40), IN orgName VARCHAR(40), IN tenantId VARCHAR(25)
             returns:
                body: BEGIN
      UPDATE p_driver SET ORG_NAME = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE a_area_alarm_rule SET ORG_NAME = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE a_nightdrive_rule SET apply_content = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE b_fatigue_driving_alarm_param SET obj_name = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE b_segment_alarm SET apply_content = orgName WHERE  ORG_CODE = orgCode AND tenant_id = tenantId;
    END
             definer: admin@%
             created: 2020-10-10 14:54:38
            modified: 2020-10-10 14:54:38
            sql_mode: STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
             comment:
character_set_client: utf8mb4
collation_connection: utf8mb4_general_ci
        db_collation: utf8mb4_general_ci
           body_utf8: BEGIN
      UPDATE p_driver SET ORG_NAME = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE a_area_alarm_rule SET ORG_NAME = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE a_nightdrive_rule SET apply_content = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE b_fatigue_driving_alarm_param SET obj_name = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE b_segment_alarm SET apply_content = orgName WHERE  ORG_CODE = orgCode AND tenant_id = tenantId;
    END
1 row in set (0.00 sec)

＃ 查看指定库内的函数
mysql> select * from mysql.proc where db="c5web" and type="function"\G
Empty set (0.00 sec)
```

### 查看创建存储过程和函数的代码

```
# 查看创建存储过程的代码
mysql> use c5web;
mysql> show create procedure pro_org_change \G
*************************** 1. row ***************************
           Procedure: pro_org_change
            sql_mode: STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
    Create Procedure: CREATE DEFINER=`admin`@`%` PROCEDURE `pro_org_change`(IN orgCode VARCHAR(40), IN orgName VARCHAR(40), IN tenantId VARCHAR(25))
BEGIN
      UPDATE p_driver SET ORG_NAME = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE a_area_alarm_rule SET ORG_NAME = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE a_nightdrive_rule SET apply_content = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE b_fatigue_driving_alarm_param SET obj_name = orgName WHERE ORG_CODE = orgCode AND tenant_id = tenantId;
     UPDATE b_segment_alarm SET apply_content = orgName WHERE  ORG_CODE = orgCode AND tenant_id = tenantId;
    END
character_set_client: utf8mb4
collation_connection: utf8mb4_general_ci
  Database Collation: utf8mb4_general_ci
1 row in set (0.00 sec)

# 查看创建函数的代码
mysql> show create function "FUNCTION_NAME";
```

## 查看指定库内的触发器

```
mysql> show triggers from c5web\G
*************************** 1. row ***************************
             Trigger: tr_depart_change
               Event: UPDATE
               Table: s_department
           Statement: BEGIN
IF new.org_name <> old.org_name  THEN
CALL pro_org_change(new.org_code,new.org_name,new.tenant_id);
END IF;
END
              Timing: AFTER
             Created: 2020-09-23 14:16:30.17
            sql_mode: STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
             Definer: root@localhost
character_set_client: utf8
collation_connection: utf8_general_ci
  Database Collation: utf8mb4_general_ci
1 row in set (0.00 sec)

mysql> select * from information_schema.triggers where trigger_name="tr_depart_change"\G
*************************** 1. row ***************************
           TRIGGER_CATALOG: def
            TRIGGER_SCHEMA: c5web
              TRIGGER_NAME: tr_depart_change
        EVENT_MANIPULATION: UPDATE
      EVENT_OBJECT_CATALOG: def
       EVENT_OBJECT_SCHEMA: c5web
        EVENT_OBJECT_TABLE: s_department
              ACTION_ORDER: 1
          ACTION_CONDITION: NULL
          ACTION_STATEMENT: BEGIN
IF new.org_name <> old.org_name  THEN
CALL pro_org_change(new.org_code,new.org_name,new.tenant_id);
END IF;
END
        ACTION_ORIENTATION: ROW
             ACTION_TIMING: AFTER
ACTION_REFERENCE_OLD_TABLE: NULL
ACTION_REFERENCE_NEW_TABLE: NULL
  ACTION_REFERENCE_OLD_ROW: OLD
  ACTION_REFERENCE_NEW_ROW: NEW
                   CREATED: 2020-09-23 14:16:30.17
                  SQL_MODE: STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
                   DEFINER: root@localhost
      CHARACTER_SET_CLIENT: utf8
      COLLATION_CONNECTION: utf8_general_ci
        DATABASE_COLLATION: utf8mb4_general_ci
1 row in set (0.01 sec)
```

# 查看processlist中某个线程的工作情况

```
# 查看所有线程的概要信息
mysql> show processlist;
+---------+--------------+--------------------+--------------------+------------------+---------+---------------------------------------------------------------+------------------+
| Id      | User         | Host               | db                 | Command          | Time    | State                                                         | Info             |
+---------+--------------+--------------------+--------------------+------------------+---------+---------------------------------------------------------------+------------------+
|    3558 | ReplUser     | 10.167.1.62:43566  | NULL               | Binlog Dump      | 1663101 | Master has sent all binlog to slave; waiting for more updates | NULL             |
|    3729 | ReplUser     | 10.167.1.63:60292  | NULL               | Binlog Dump      | 1663059 | Master has sent all binlog to slave; waiting for more updates | NULL             |
|   88200 | mycat        | 10.167.1.103:53694 | c5web              | Sleep            |      31 |                                                               | NULL             |
|   88243 | mycat        | 10.167.1.103:53696 | c5web              | Sleep            |      26 |                                                               | NULL             |
|   88888 | mycat        | 10.167.1.103:53720 | c5web              | Sleep            |      42 |                                                               | NULL             |
......
| 5362313 | mycat        | 10.167.1.103:47940 | c5web              | Sleep            |      51 |                                                               | NULL             |
| 5403793 | root         | localhost          | performance_schema | Query            |       0 | starting                                                      | show processlist |
+---------+--------------+--------------------+--------------------+------------------+---------+---------------------------------------------------------------+------------------+
54 rows in set (0.00 sec)

# 通过查看 performance_schema.threads 表可查看 process_id 的详细情况
mysql> select * from performance_schema.threads limit 1 \G
*************************** 1. row ***************************
          THREAD_ID: 91385
               NAME: thread/sql/one_connection
               TYPE: FOREGROUND
     PROCESSLIST_ID: 91347
   PROCESSLIST_USER: mycat
   PROCESSLIST_HOST: 10.167.1.103
     PROCESSLIST_DB: c5web
PROCESSLIST_COMMAND: Sleep
   PROCESSLIST_TIME: 3
  PROCESSLIST_STATE: NULL
   PROCESSLIST_INFO: insert into n_alarm_info
    (ALARM_ID,ALARM_TYPE,ALARM_CODE,VEHICLE_ID,ORGCODE,LNG,LAT,ADDRESS,DESCRIBES,
    SPEED,ALARM_TIME,RECORD_TIME,EXE_STATUS,PROCESSOR_CODE,PROCESSOR_TIME,PLATE,
    PLATE_COLOR_ID,ORGNAME,ALT,MAINDRIVER_ID,MAINDRIVER_NAME,DIRECTION,COMMANDID,
    PROCESSMODE,PROCESSNAME,RECODER,ALARMLEVEL,ALARM_SEQUENCE,TENANT_ID)
    values

          ( '1602685520000_10309621_9998', 1, 9998, 10309621, 'B000212303',
            110.878042, 21.693716, '广东省茂名市茂南区采矿路', '位置信息异常报警', 0.0,
            '2020-10-14 22:25:20.0', '2020-10-14 22:25:23.522', 0, null, null,
            '桂N91310', '2', '钦州市兴通运输有限责任公司', 0.0, null,
            null, '0', null, null, null,
            null, null, null,'0')
         ,
          ( '1602686835000_3446_9998', 1, 9998, 3446, 'B0002003010906',
            114.454047, 28.071097, '江西省宜春市万载县', '位置信息异常报警', 0.0,
            '2020-10-14 22:47:15.0', '2020-10-14 22:25
   PARENT_THREAD_ID: NULL
               ROLE: NULL
       INSTRUMENTED: YES
            HISTORY: YES
    CONNECTION_TYPE: TCP/IP
       THREAD_OS_ID: 8932
1 row in set (0.00 sec)
```

在 mysql 的 performance_schema 库中的 threads 表中可查看到 processlist_id 对应的系统上的进程号，以及该线程正在执行的内容。

## 查看系统的进程对应的processlist_id对应的信息

```
mysql> select * from information_schema.processlist where id = (select processlist_id from performance_schema.threads where thread_os_id=6212);
+--------+-----------+---------------------+------+---------+------+-------+------+
| ID     | USER      | HOST                | DB   | COMMAND | TIME | STATE | INFO |
+--------+-----------+---------------------+------+---------+------+-------+------+
| 598508 | tiisp2020 | 10.169.10.157:57231 | NULL | Sleep   | 1359 |       | NULL |
+--------+-----------+---------------------+------+---------+------+-------+------+

# 查看与mysql线程与os的pid对应的进程的状态
mysql> SELECT a.THREAD_OS_ID,b.user,b.host,b.db,b.command,b.time,b.state FROM performance_schema.threads a,information_schema.processlist b WHERE b.id = a.processlist_id order by b.time desc;
+--------------+-----------+-------------------+--------------------+-------------+---------+---------------------------------------------------------------+
| THREAD_OS_ID | user      | host              | db                 | command     | time    | state                                                         |
+--------------+-----------+-------------------+--------------------+-------------+---------+---------------------------------------------------------------+
|         6214 | tiisp2020 | 10.168.2.66:58746 | NULL               | Binlog Dump | 1031339 | Master has sent all binlog to slave; waiting for more updates |
|         8248 | tiisp2020 | 10.168.2.33:40798 | c5web              | Sleep       |    1768 |                                                               |
|        80558 | tiisp2020 | 10.168.2.33:40802 | c5web              | Sleep       |    1759 |                                                               |
|        80574 | tiisp2020 | 10.168.2.33:40808 | c5web              | Sleep       |    1735 |                                                               |
|        80590 | tiisp2020 | 10.168.2.33:40816 | c5web              | Sleep       |    1691 |                                                               |
|        80539 | tiisp2020 | 10.168.2.33:40832 | c5web              | Sleep       |    1646 |                                                               |
|         8130 | tiisp2020 | 10.168.2.33:40836 | c5web              | Sleep       |    1636 |                                                               |
|        80564 | tiisp2020 | 10.168.2.33:40838 | c5web              | Sleep       |    1627 |                                                               |
|         8152 | tiisp2020 | 10.168.2.33:40848 | c5web              | Sleep       |    1579 |                                                               |
|         6236 | tiisp2020 | 10.168.2.33:40860 | c5web              | Sleep       |    1532 |                                                               |
......
|         7931 | tiisp2020 | 10.168.2.33:32990 | c5web              | Query       |       0 | Sending data                                                  |
|        80561 | tiisp2020 | 10.168.2.33:58050 | c5web              | Query       |       0 | Sending data                                                  |
|        79076 | tiisp2020 | 10.168.2.33:59634 | c5web              | Query       |       0 | Sending data                                                  |
|         8213 | tiisp2020 | 10.168.2.33:36162 | c5web              | Query       |       0 | Sending data                                                  |
|        10222 | tiisp2020 | 10.168.2.33:33780 | c5web              | Query       |       0 | Sending data                                                  |
|         8322 | root      | localhost         | NULL               | Query       |       0 | executing                                                     |
|        80527 | tiisp2020 | 10.168.2.33:36160 | c5web              | Query       |       0 | Sending data                                                  |
+--------------+-----------+-------------------+--------------------+-------------+---------+---------------------------------------------------------------+
88 rows in set (0.00 sec)


# 通过两个表的内联结来查看指定的系统进程对应的mysql的processlist的详细信息
mysql> select Thread_os_id,processlist_id,processlist_info,user,host from performance_schema.threads as t , information_schema.processlist as p where t.PROCESSLIST_ID=p.id and thread_os_id=80488\G
*************************** 1. row ***************************
    Thread_os_id: 80488
  processlist_id: 593127
processlist_info: SELECT
        t.alarmCode,
        t.alarmName,
        t.alarmCount
        FROM
        (
        SELECT
        alarm_code alarmCode,
        MAX( alarm_name ) AS alarmName,
        SUM( alarm_count ) AS alarmCount
        FROM
        a_alarm_vehicle_day
        WHERE
        1=1

            AND alarm_day >= '2020-10-01'


            AND alarm_day < '2020-11-01'


            AND org_code LIKE CONCAT('B', '%')


            AND tenant_id = 0


            AND alarm_type = 2


            AND alarm_code IN
             (
                650504
             ,
                650501
             ,
                650503
             ,
                650502
             )

        GROUP BY
        alarm_code UNION ALL
        SELECT
        - 1 AS alarmCode,
        '全部' AS alarmName,
        SUM( alarm_count ) AS alarmCount
        FROM
        a_alarm_vehicle_day
        WHERE
        1=
            user: tiisp2020
            host: 10.168.2.17:36938
1 row in set (0.00 sec)
```

## 查看当前数据库中的活跃的事务

```
mysql> select trx_state,trx_started,trx_wait_started,trx_weight,trx_rows_locked,now() from information_schema.innodb_trx;
```

# 查询当前库中没有主键的用户表

```
# 查找有主键的表（使用distinct可去除重复的记录）
mysql> select distinct table_name from columns where column_key = "pri";
    +--------------------------------+
    | table_name                     |
    +--------------------------------+
    | AO_187CCC_SIDEBAR_LINK         |
    | AO_21D670_WHITELIST_RULES      |
    | AO_21F425_MESSAGE_AO           |
    | AO_21F425_MESSAGE_MAPPING_AO   |
    | AO_21F425_USER_PROPERTY_AO     |
    ......
    | parent                         |
    | t0                             |
    | t1                             |
    +--------------------------------+
    356 rows in set (0.19 sec)

# 只要表名不在上述所查出来的表中即为没有主键的表，只要库名不为'mysql'，'sys'，'information_schema'，'performance_schema'即为用户库下的用户表
mysql> select table_schema,table_name from tables where
    -> table_name not in
    -> (select distinct table_name from columns where column_key="pri") and
    -> table_schema not in ('mysql','sys','information_schema','performance_schema');
    +--------------+---------------------+
    | table_schema | table_name          |
    +--------------+---------------------+
    | c5web        | dc3                 |
    | c5web        | oauth_access_token  |
    | c5web        | oauth_approvals     |
    | c5web        | oauth_client_token  |
    | c5web        | oauth_refresh_token |
    | c5web        | s_national_region   |
    | c5web        | v_vehicletype       |
    +--------------+---------------------+
```

# 查看B+树的信息

## 查看B+树的高度

![innodb_索引结构与页内数据组织](../pic/innodb_索引结构与页内数据组织.png)

```
# 在该表中的page_no即表示索引根页的页号
mysql> select b.name,a.name,index_id,type,a.space,a.page_no from information_schema.innodb_sys_indexes a , information_schema.innodb_sys_tables b where a.table_id= b.table_id and a.space <> 0;
+-------------------------------------+------------------------------------+----------+------+-------+---------+
| name                                | name                               | index_id | type | space | page_no |
+-------------------------------------+------------------------------------+----------+------+-------+---------+
| c5web/a_alarm_org_hour              | PRIMARY                            |      383 |    3 |   219 |       3 |
| c5web/a_alarm_vehicle_day           | PRIMARY                            |      384 |    3 |   220 |       3 |
| c5web/a_alarm_vehicle_day           | INX_ORG_CODE                       |      385 |    0 |   220 |       4 |
| c5web/a_alarm_vehicle_day           | INX_ALARM_DAY_CODE_VEH_ID          |      613 |    0 |   220 |       5 |
| c5web/a_alarmtype                   | PRIMARY                            |      387 |    3 |   221 |       3 |
| c5web/a_area_alarm                  | PRIMARY                            |      388 |    3 |   222 |       3 |
| c5web/a_area_alarm_rule             | PRIMARY                            |      389 |    3 |   223 |       3 |
| c5web/a_nightdrive_rule             | PRIMARY                            |      390 |    3 |   224 |       3 |
| c5web/a_weekly_email                | PRIMARY                            |      391 |    3 |   225 |       3 |
...
...
| c5web/n_alarm_info                  | PRIMARY                            |      411 |    3 |   243 |       3 |
| c5web/n_alarm_info                  | IDX_TYPE_CODE                      |      606 |    0 |   243 |   57358 |
| c5web/n_alarm_info                  | IDX_TIME__TENANT_ORG_EXE           |      607 |    0 |   243 |      22 |
...
| sys/sys_config                      | PRIMARY                            |       40 |    3 |    25 |       3 |
| testdb/checksums                    | PRIMARY                            |      582 |    3 |   322 |       3 |
| testdb/checksums                    | ts_db_tbl                          |      583 |    0 |   322 |       4 |
+-------------------------------------+------------------------------------+----------+------+-------+---------+
210 rows in set (0.01 sec)

mysql> select @@innodb_page_size;
+--------------------+
| @@innodb_page_size |
+--------------------+
|               8192 |
+--------------------+
1 row in set (0.01 sec)

mysql> select 57358*8192 + 64;
+-----------------+
| 57358*8192 + 64 |
+-----------------+
|       469876800 |
+-----------------+
1 row in set (0.00 sec)

shell> hexdump -s 469876800 -n 2 -c ./n_alarm_info.ibd
1c01c040  \0 003
1c01c042
```

由于InnoDB中索引的高度是从0开始计算，因此此处真正的索引的高度是4。

## 查看数据库中用户表与SPACE_NO与表名的对应关系

```
# 表中的PAGE_NO即为索引页中ROOT页的页号，type即为索引类型
mysql> select b.name,a.name,index_id,type,a.space,a.PAGE_NO from information_schema.INNODB_SYS_INDEXES a , information_schema.INNODB_SYS_TABLES b where a.table_id = b.table_id and a.space != 0 and b.name like "teleport%";
+--------------------------+---------+----------+------+-------+---------+
| name                     | name    | index_id | type | space | PAGE_NO |
+--------------------------+---------+----------+------+-------+---------+
| teleport/tp_acc          | PRIMARY |       47 |    3 |    32 |       3 |
| teleport/tp_acc_auth     | PRIMARY |       48 |    3 |    33 |       3 |
| teleport/tp_audit_auz    | PRIMARY |       55 |    3 |    40 |       3 |
| teleport/tp_audit_map    | PRIMARY |       56 |    3 |    41 |       3 |
| teleport/tp_audit_policy | PRIMARY |       54 |    3 |    39 |       3 |
| teleport/tp_config       | PRIMARY |       41 |    3 |    26 |       3 |
| teleport/tp_core_server  | PRIMARY |       42 |    3 |    27 |       3 |
| teleport/tp_group        | PRIMARY |       49 |    3 |    34 |       3 |
| teleport/tp_group_map    | PRIMARY |       50 |    3 |    35 |       3 |
| teleport/tp_host         | PRIMARY |       46 |    3 |    31 |       3 |
| teleport/tp_ops_auz      | PRIMARY |       52 |    3 |    37 |       3 |
| teleport/tp_ops_map      | PRIMARY |       53 |    3 |    38 |       3 |
| teleport/tp_ops_policy   | PRIMARY |       51 |    3 |    36 |       3 |
| teleport/tp_record       | PRIMARY |       58 |    3 |    43 |       3 |
| teleport/tp_record_audit | PRIMARY |       59 |    3 |    44 |       3 |
| teleport/tp_role         | PRIMARY |       43 |    3 |    28 |       3 |
| teleport/tp_syslog       | PRIMARY |       57 |    3 |    42 |       3 |
| teleport/tp_user         | PRIMARY |       44 |    3 |    29 |       3 |
| teleport/tp_user_rpt     | PRIMARY |       45 |    3 |    30 |       3 |
+--------------------------+---------+----------+------+-------+---------+
19 rows in set (0.02 sec)
```

# 因开启query_cache导致的Waiting for query cache lock

mysql开启query_cache后在执行一个query时会先锁住query_cache，然后判断是否在query_cache中，如果存在则直接返回结果，如不存在则进行引擎查询。而所有的insert、update和delete的操作都会清空query_cache中被影响的表的缓存，从而重新开始cache数据。

那么在数据库不是那么频繁更新的时候，query_cache可以在本地形成缓存提高RT的响应时间，但如果写入非常频繁并集中在某几张表上的时候，query_cache的锁会造成频繁的锁冲突，对于这一张表的读和写会互相等待query_cache_lock解锁，导致select的查询效率下降。