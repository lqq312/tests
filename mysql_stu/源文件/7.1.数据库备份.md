[TOC]

# 备份类型

* 热备
  * 在线备份
  * 对应用基本无影响
* 冷备
  * 备份数据文件
  * 需要停机
  * 备份datadir目录下的所有文件
* 温备
  * 在线备份
  * 对应用影响较大
  * 通常加一个读锁

# 备份策略

* 全量备份
* 增量备份
* 差异备份

# 备份工具

* ibbackup
  * 官方备份工具
  * 收费
  * 物理备份
* xtrabackup
  * 开源社区备份工具
  * 开源免费
  * 物理备份
* mysqldump（mysqlpump）
  * 官方自带备份工具
  * 开源免费
  * 逻辑备份
* mysqldumper

物理备份与逻辑备份的差异在于：物理备份备份的是表空间中的数据，而逻辑备份备份的是表中的数据（即sql语句）。

MySQL5.6的版本建议使用xtrabackup2.2.3以上的版本，此前版本的xtrabackup在备份数据时容易丢失最后一组数据。

## 逻辑备份＆物理备份

|            | 逻辑备份                                   | 物理备份                                       |
| ---------- | ------------------------------------------ | ---------------------------------------------- |
| 备份方式   | 备份数据为逻辑内容                         | 备份数据库物理文件                             |
| 优点       | 备份文件相对较小（只备份表中的数据与结构） | 恢复速度比较快（物理文件恢复基本已经完成恢复） |
| 缺点       | 恢复速度较慢（需要重建索引、存储过程等）   | 备份文件相对较大（备份表空间，包含数据与索引） |
| 对业务影响 | 缓冲池污染、I/O负载加大                    | I/O负载加大                                    |
| 代表工具   | mysqldump                                  | ibbackup，xtrabackup                           |

建议从以下维度选择备份方式：

* 备份速度
* 恢复速度
* 备份大小
* 对业务影响

# 数据备份与恢复

数据备份之前应该检查库中数据的大小，以准备备份数据存放的空间大小，建议将备份数据与数据库分别存放在不同的物理介质上。

```
######################## 查看库的大小 ########################
mysql> select concat(round(sum(`DATA_LENGTH` / 1024 / 1024), 2), ' MB') as data
    -> from `information_schema`.`tables`
    -> where table_schema = 'c5web';
+------------+
| data       |
+------------+
| 2500.70 MB |
+------------+
1 row in set (0.01 sec)


######################## 查看表的大小 ########################
mysql> select table_name,data_length+index_length,table_rows from information_schema.tables where table_schema="t1" and table_name="t_siminfo";
+------------+--------------------------+------------+
| table_name | data_length+index_length | table_rows |
+------------+--------------------------+------------+
| t_siminfo  |                  2359296 |      10860 |
+------------+--------------------------+------------+
1 row in set (0.00 sec)

######################## 计算表的大小（结果单位为MB） ########################
mysql> select 2359296 / 1024/ 1024;
+----------------------+
| 2359296 / 1024/ 1024 |
+----------------------+
|           2.25000000 |
+----------------------+
```

进行物理备份除了会备份表空间中的数据还会将undolog、redolog一并进行备份，因此需要考虑这两个日志额外的存储空间。

**除数据文件外，应该定期备份MySQL数据库的配置文件和库的表空间文件即“.frm”文件，另外如需恢复时间点的数据则应该对二进制日志文件进行必要的备份。**

***使用工具进行数据备份在恢复时仅能恢复到备份那一时刻的数据，如需恢复到误操作前的数据需要使用二进制日志进行数据恢复。使用innobackupex备份后的xtrabackup_binlog_pos_innodb文件中保存有备份完成时二进制日志所使用的文件和position。***

## 使用xtrabackup进行数据备份

### 二进制安装xtrabackup

```
shell> wget http://local-yum.ycigilink.local/Softwares/mysql/percona-tools/percona-xtrabackup-2.4.20-Linux-x86_64.el7.tar.gz
shell> tar axf percona-xtrabackup-2.4.20-Linux-x86_64.el7.tar.gz -C /usr/local
shell> ln -sv /usr/local/percona-xtrabackup-2.4.20-Linux-x86_64 /usr/local/percona-xtrabackup
‘/usr/local/percona-xtrabackup’ -> ‘/usr/local/percona-xtrabackup-2.4.20-Linux-x86_64’
shell> echo 'export PATH="/usr/local/percona-xtrabackup/bin":${PATH}' > /etc/profile.d/percona-xtrabackup.sh
shell> source /etc/profile.d/percona-xtrabackup.sh
shell> yum -y install perl-Data-Dumper perl-Digest-MD5 perl-DBD-MySQL rsync
```

### 全量备份与恢复

1. 数据库备份（备份时仅使用10个线程）

   ```
   shell> innobackupex --defaults-file=/etc/my.cnf --rsync --user=root --host=localhost --password=ycig1234 --database="t1" --no-timestamp --parallel=10 /backup/mysql/FullBackup/20200916
   ```

   注意：在mysql主从的架构中备份从库则需要加上“--slave-info”的选项使得在备份的时候加上“position”和主库的名字等信息。

2. 数据库恢复

   ```
   ######################## 数据恢复前的准备阶段 ########################
   shell> innobackupex --apply-log --use-memory=4096M /backup/mysql/FullBackup/20200916
   shell> systemctl stop mysqld
   shell> systemctl status mysqld

   ######################## 测试恢复时需要清空数据目录下的所有文件 ########################
   shell> rm -rf /db/mysql/data/*
   shell> rm -rf /db/mysql/redologs/*
   shell> rm -rf /db/mysql/undologs/*

   ######################## 执行数据恢复 ########################
   shell> innobackupex --copy-back /backup/mysql/FullBackup/20200916
   shell> chown -R mysql.mysql /db/mysql/*
   shell> systemctl start mysqld
   ```


### 增量备份与恢复

增备是备份上次全量备份以来发生变化的页面，通过增量备份可以减轻存储以及系统资源开销。增量备份主要针对于InnoDB，因为InnoDB采用了日志序列号（LSN）的方式。InnoDB的LSN是一个增长的序列，类似于Oracle的SCN，记录了InnoDB的变化情况。增量备份则是备份特定的LSN之后变化的情况。通过按序重组这些LSN即可将数据库恢复到故障点或任意时刻。

因此增加备份需要指定上一次全量备份的文件或上一次增量备份的文件。

对于恢复增量备份的Prepare阶段，有2个需要注意的地方，一个是提交的事务需要replayed（重放），另外是未提交的事务需要rollback（回滚）。如果在Prepare阶段replay了已提交的事务以及回滚了未提交的事务，则后续的增量备份无法添加到当前全备。因此在Prepare阶段全备应使用“--redo-only”选项。对于存在多次增量备份的情形，只有最后一个增量备份不需要使用“--redo-only”选项。如果使用了则rollback将由服务器启动的时候来完成。

1. 进行数据库的全量备份

   ```
   shell> innobackupex --defaults-file=/etc/my.cnf --rsync --user=root --host=localhost --password=ycig1234 --database="t1" --no-timestamp --parallel=10 /backup/mysql092/FullBackup/20200916
   ```

2. 为测试增量备份的效果，向库中创建一个新表并插入数据

   ```
   mysql> use c5web;
   mysql> create table t1(id int not null);
   Query OK, 0 rows affected (0.86 sec)

   mysql> insert into t1 (id) values (1),(2),(3);
   Query OK, 3 rows affected (0.11 sec)
   Records: 3  Duplicates: 0  Warnings: 0

   mysql> select * from t1;
   +----+
   | id |
   +----+
   |  1 |
   |  2 |
   |  3 |
   +----+
   3 rows in set (0.01 sec)
   ```

3. 基于第一次的全量备份进行第一次增量备份

   ```
   shell> mkdir -pv /backup/mysql092/IncreBackup/20200916_1
   shell> innobackupex --defaults-file=/etc/my.cnf --rsync --user=root --host=localhost --password=ycig1234 --no-timestamp --incremental /backup/mysql092/IncreBackup/20200916_1 --incremental-basedir=/backup/mysql092/FullBackup/20200916
   ```

4. 在第一次增量备份后再修改t1表中的数据

   ```
   mysql> alter table t1 add (name char null);
   Query OK, 0 rows affected (1.12 sec)
   Records: 0  Duplicates: 0  Warnings: 0

   mysql> insert into t1 (id, name) values (4,"t");
   Query OK, 1 row affected (0.10 sec)

   mysql> select * from t1;
   +----+------+
   | id | name |
   +----+------+
   |  1 | NULL |
   |  2 | NULL |
   |  3 | NULL |
   |  4 | t    |
   +----+------+
   4 rows in set (0.00 sec)
   ```

5. 基于第一次的增量备份进行第二次的增量备份

   ```
   shell> mkdir -pv /backup/mysql092/IncreBackup/20200916_2
   shell> innobackupex --defaults-file=/etc/my.cnf --rsync --user=root --host=localhost --password=ycig1234 --no-timestamp --incremental /backup/mysql092/IncreBackup/20200916_2 --incremental-basedir=/backup/mysql092/IncreBackup/20200916_1
   ```

6. 执行数据恢复前的准备工作（将多次增量备份的数据应用到全量备份的数据文件上）

   在该阶段除应用最后一次增量备份的文件时无需使用“\-\-redo-only”，准备其他数据时都应该使用“\-\-redo-only”选项

   ```
   shell> innobackupex --apply-log --redo-only --use-memory=4096M /backup/mysql092/FullBackup/20200916
   shell> innobackupex --apply-log --redo-only --use-memory=4096M --incremental-dir=/backup/mysql092/IncreBackup/20200916_1 /backup/mysql092/FullBackup/20200916
   shell> innobackupex --apply-log --use-memory=4096M --incremental-dir=/backup/mysql092/IncreBackup/20200916_2 /backup/mysql092/FullBackup/20200916
   shell> innobackupex --apply-log --use-memory=4096M /backup/mysql092/FullBackup/20200916
   ```

7. 执行数据恢复操作

   ```
   ######################## 测试恢复时需要停止数据为并清空数据目录下的所有文件 ########################
   shell> systemctl stop mysqld
   shell> systemctl status mysqld
   shell> cd /db/mysql/
   shell> rm -rf data/* redologs/* undologs/*

   ######################## 执行数据恢复 ########################
   shell> innobackupex --defaults-file=/etc/my.cnf --rsync --copy-back /backup/mysql092/FullBackup/20200916
   shell> chown -R mysql.mysql /db/mysql/*
   shell> systemctl start mysqld
   ```

8. 登陆数据库后验证数据是否恢复

   ```
   shell> mysql -uroot -hlocalhost -p
   mysql> use c5web;
   mysql> select * from t1;
   +----+------+
   | id | name |
   +----+------+
   |  1 | NULL |
   |  2 | NULL |
   |  3 | NULL |
   |  4 | t    |
   +----+------+
   4 rows in set (0.05 sec)
   ```

## 使用mysqldump进行数据备份

mysqldump详解参照2.2章“mysqldump命令”。

```
shell> mysqldump -uroot -hlocalhost -p --single-transaction --master-data=1 test_db > ./test_db.sql
```

## 使用mysqlpump进行数据备份

## 使用mydumper进行数据备份

## 使用二进制日志进行时间点还原

