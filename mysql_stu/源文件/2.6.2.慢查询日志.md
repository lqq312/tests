[TOC]

# 慢查询日志迭代历程

1. 将运行超过某个时间阈值的SQL语句记录到文件（文件名默认为“机器名.slow.log”）。
2. MySQL从5.1开始可以以毫秒为单位记录运行的SQL语句。
3. MySQL从5.5开始可以将慢查询日志保存到表中。
4. MySQL从5.6开始可以更细粒度的记录慢查询。
5. MySQL从5.7开始可以将时区信息写入到慢查询日志中。

## 慢查询相关参数

* slow_query_log：定义是否开启慢查询日志（bool值，yes/no，on/off，0/1），可在线修改，建议开启。

  > mysql> SET GLOBAL slow_query_log=1;

* slow_query_log_file：定义慢查询日志的路径和文件名。

* long_query_time：定义慢查询日志的阈值，超过该时间的即记录为慢查询，“long_query_time”的单位是，建议设置为“2s”。

* min_examined_row_limit：扫描记录少于该值的SQL语句不记录到慢查询日志，即使这个语句执行时间超过了long_query_time的阈值，建议设置为字典表的行数。

  > 一旦开启“log_queries_not_using_indexes”所有没有使用索引的SQL都会记录到慢查日志中，但有些表是字典表，而应用会定期去扫描该表，并且该表的行数也不多

* log_queries_not_using_indexes：将没有使用索引的SQL记录到慢查询日志中（bool值），建议开启。

* log_throttle_queries_not_using_indexes：限制每分钟记录没有使用索引的SQL语句的次数，超过这个数目后只记录语句数量和花费的总时间，避免慢查日志过大，可设置为“10”。

* log_slow_admin_statement：定义是否记录管理操作，如“ALTER”、“ANALYZE TABLE”、“check table”、“create index”、“drop index”、“optimize table”、“repair table”（bool值），建议开启。

* log_slow_slave_statements = 1：从库上执行得很慢的SQL语名是否也记录到慢查询日志中（bool值），建议开启。

* log_output：定义慢查询日志的格式，其值可以为“FILE”、“TABLE”或“NONE”（默认为“FILE”）。

  > 1. 如果将慢查日志存放到文件中可使用“mysqldumpslow”命令进行查看，如果将慢查日志存放到表中可方便的进行统计，一般建议将其保存为“FILE”格式，因为如果备份的时候没有指定，会将慢查日志也一并备份，而慢查日志随着业务的增加，其数据量也会增加从而导致备份的数据也会很大。
  >
  > 2. Log_output可通过“set global log_output="TABLE";”在线修改。

* log_timestamps：定义是否写入时区信息，可指定为“sys”。

## 慢查询日志中的内容

以下的测试中已将“min_examined_row_limit”的值设置为0，无论其扫描的行数只要查询时间大于“long_query_time”就记录为慢查询。

```
# Time: 2020-03-21T15:04:19.528583+08:00
# User@Host: root[root] @ localhost []  Id:    85
# Query_time: 15.001371  Lock_time: 0.000431 Rows_sent: 0  Rows_examined: 3
SET timestamp=1584774259;
select * from tb0 where sleep(5);
```

Time：表示SQL执行的时间；

Query_time：表示这条SQL执行的时间；

Lock_time：表示执行这条SQL持有锁的时长；

Rows_sent：返回客户端的行数；

Rows_examined：表示扫描的行数。



查看时间戳的具体时间：SET timestamp=1584774259表示距1970-01-01 00:00:01经过的秒数。

```
shell> date -d @1584774259
Sat Mar 21 15:04:19 CST 2020
```

## 使用mysqldumpslow查看慢查询日志

```
shell> mysqldumpslow mysql.slow 

Reading mysql slow query log from mysql.slow
Count: 1  Time=15.00s (15s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost
  select * from tb0 where sleep(N)

Count: 1  Time=5.00s (5s)  Lock=0.00s (0s)  Rows=1.0 (1), root[root]@localhost
  select sleep(N)

```

该命令可将慢查询日志进行格式化后展示出来。



线上业务慢查询日志分析：

```
shell> tail -10000 mysql.slow | mysqldumpslow
```

线上的库如果很慢则会导致慢查询日志增长很快，因此不建议使用mysqldumpslow扫整个慢查日志文件。

## 将慢查询日志存放到表中

将慢查询日志存放到表中可以很方便的进行某些字段的统计。

```
shell> vim /etc/my.cnf
    slow_query_log=1
    slow_query_log_file=mysql.slow.log
    long_query_time=3
    log_output=TABLE
shell> systemctl restart mysqld
shell> mysql --login-path=local_master

mysql> SHOW TABLES FROM mysql;
mysql> SELECT * FROM slow_log;
*************************** 1. row ***************************
    start_time: 2020-03-21 16:18:27.653314
     user_host: root[root] @ localhost []
    query_time: 00:00:03.000364
     lock_time: 00:00:00.000000
     rows_sent: 1
 rows_examined: 0
            db: mysql
last_insert_id: 0
     insert_id: 0
     server_id: 200314190
      sql_text: select sleep(3)
     thread_id: 87
*************************** 2. row ***************************
    start_time: 2020-03-21 16:18:34.685368
     user_host: root[root] @ localhost []
    query_time: 00:00:00.000410
     lock_time: 00:00:00.000170
     rows_sent: 1
 rows_examined: 1
            db: mysql
last_insert_id: 0
     insert_id: 0
     server_id: 200314190
      sql_text: select * from slow_log
     thread_id: 87
```

将“log_output”设置为“TABLE”重启数据库后会在mysql库下生成一个名为“slow_log”的表。

### 修改slow_log的存储引擎

“mysql.slow_log”表使用的存储引擎是“CSV”，而“CSV”的性能并不是特别好，建议将其修改为“myisam”。

```
mysql> SET GLOBAL slow_query_log=off;
mysql> ALTER TABLE slow_log ENGINE=myisam;
mysql> SET GLOBAL slow_query_log=on;
mysql> SHOW CREATE TABLE slow_log\G
```

