[TOC]

# MySQL Proxy概述

利用MySQL proxies_priv（模拟角色）实现类似用户组管理，角色（Role）可以用来批量管理用户，同一个角色下的用户，拥有相同的权限。

## 在MySQL5.7中开启proxy功能

mysql5.7中要开启proxy功能需要开启以下三个变量：

* check_proxy_users，用于启用用户映射功能，如不开启授权的用户可登陆至mysql，但不会具有角色的权限；
* mysql_native_password_proxy_users，启用mysql_native_password插件的用户认证功能；
* sha256_password_proxy_users，启用sha256_password插件的用户认证功能。

**注意：以上功能需要要配置文件中指定，否则仅通过修改变量的方式在重启后会失效。**

## 在mysql5.7中创建角色并授权

在该示例中创建一个角色为“dev_user”@“192.168.3.%”，为其授权test_db库下所有表的select和create权限。创建一个“jim”@“192.168.3.%”的用户，该用户属于“dev_user”@“192.168.3.%”。

1. 在配置文件中开启proxy功能

```
shell> vim /etc/my.cnf
		......
		[mysqld]
		......
		########proxy settings########
		check_proxy_users = 1
		mysql_native_password_proxy_users = 1
		sha256_password_proxy_users = 1
		......
shell> systemctl restart mysqld
shell> mysql --login-path=local_master
mysql> show variables like "%proxy%";
+-----------------------------------+-------+
| Variable_name                     | Value |
+-----------------------------------+-------+
| check_proxy_users                 | ON    |
| mysql_native_password_proxy_users | ON    |
| proxy_user                        |       |
| sha256_password_proxy_users       | ON    |
+-----------------------------------+-------+
```

2. 进入mysql创建角色用户并向其授权

```
mysql> create user "dev_user"@"192.168.3.%" identified by "ycigIlink@123";
mysql> grant select,create on test_db.* to "dev_user"@"192.168.3.%";
mysql> flush privileges;
mysql> show grants for "dev_user"@"192.168.3.%";
+-----------------------------------------------------------------+
| Grants for dev_user@192.168.3.%                                 |
+-----------------------------------------------------------------+
| GRANT USAGE ON *.* TO 'dev_user'@'192.168.3.%'                  |
| GRANT SELECT, CREATE ON `test_db`.* TO 'dev_user'@'192.168.3.%' |
+-----------------------------------------------------------------+
```

3. 创建“jim”@“192.168.3.%”并向其授权为'dev_user'@'192.168.3.%'下的用户

```
mysql> create user "jim"@"192.168.3.%" identified by "ycig1234";
mysql> show grants for "jim"@"192.168.3.%";
+-------------------------------------------+
| Grants for jim@192.168.3.%                |
+-------------------------------------------+
| GRANT USAGE ON *.* TO 'jim'@'192.168.3.%' |
+-------------------------------------------+
mysql> grant proxy on 'dev_user'@'192.168.3.%' to 'jim'@'192.168.3.%';
mysql> show grants for "jim"@"192.168.3.%";
+----------------------------------------------------------------+
| Grants for jim@192.168.3.%                                     |
+----------------------------------------------------------------+
| GRANT USAGE ON *.* TO 'jim'@'192.168.3.%'                      |
| GRANT PROXY ON 'dev_user'@'192.168.3.%' TO 'jim'@'192.168.3.%' |
+----------------------------------------------------------------+
mysql> flush privileges;
mysql> select * from proxies_priv\G
************************** 1. row ***************************
        Host: localhost
        User: root
Proxied_host: 
Proxied_user: 
  With_grant: 1
     Grantor: boot@connecting host
   Timestamp: 0000-00-00 00:00:00
*************************** 2. row ***************************
        Host: 192.168.3.%
        User: jim
Proxied_host: 192.168.3.%
Proxied_user: dev_user
  With_grant: 0
     Grantor: root@localhost
   Timestamp: 0000-00-00 00:00:00
```



