[TOC]

# mysql服务命令——mysqld

# mysql升级命令——mysql_upgrade

# mysql服务端工具——mysqldumpslow

# mysql备份工具——mysqldump

mysqldump是mysql官方提供的单线程备份工具。

## 语法格式

```
mysqldump [OPTIONS] --single-transaction　database [tables]
mysqldump [OPTIONS] --single-transaction　--databases [OPTIONS] DB1 [DB2 DB3...]
mysqldump [OPTIONS] --single-transaction　--all-databases [OPTIONS]
```

OPTIONS：

```
-A, --all-databases：备份所有库。

--single-transaction：指定该选项以实现一致性的快照的备份，在一个事务中备份出所有表，只能在支持MVCC的存储引擎中使用（默认即InnoDB），使用该选项备份出来的数据一定是命令执行的那一时刻的数据。

--master-data＝#：建议将该值设置为1，可在备份出的文件中显示“CHANGE MASTER TO MASTER_LOG_FILE='XXXXXX',MASTER_LOG_POS=XXX”的信息，该信息用于记录备份那一刻二进制日志所在的位置，如果使用该文件部署mysql主从则会从该位置开始执行数据同步。

--set-gtid-purged=OFF：如不使用该选项会导出数据库的全部gtid，可能在其他数据库恢复数据时产生gtid重复的情况因此建议关闭，而在执行主从同步的数据初始同步的时候则建议打开，从而保证主从数据库上的gtid是一致的。

-extended-insert, -e：使用具有多个VALUES列的INSERT语法；这样可使得导出的文件更小，并加速导入时的速度。默认为打开。

--skip-extended-insert：禁用多个VALUES列的INSERT语法，不建议使用。

--flush-logs：在导出之前打开一个新的二进制日志文件。

--dump-slave：

--include-master-host-port：在“--dump-slave”产生的“CHANGE MASTER TO”语句中增加“MASTER_HOST=<host>,MASTER_PORT=<port>”。

--log-error：附加警告和错误信息到指定文件中。

--no-create-db, -n：只导出数据而不添加“CREATE DATABASE”语句。

--no-create-info, -t：只导出数据，而不添加“CREATE TABLE”语句。

--no-data：只导出表结构而不导出任何数据。

--routines, -R：导出存储过程以及自定义函数。

--triggers：导出触发器。

--tz-utc：在导出的文件顶部设置时区“TIME_ZONE='+00:00'”，以保证在不同时区导出的TIMESTAMP数据或者数据被移动到其他时区时的正确性。
```

### 一致性备份详解

![mysqldump_一致性](/Users/luqq/Documents/02_tec-doc/mysql_note/pic/mysqldump_一致性.png)

```
############################ Terminal1 ############################
(root@localhost) [test_db]> show global variables like "general_log";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| general_log   | OFF   |
+---------------+-------+
1 row in set (0.00 sec)

(root@localhost) [test_db]> show global variables like "log_output";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_output    | FILE  |
+---------------+-------+
1 row in set (0.00 sec)

(root@localhost) [test_db]> set global log_output = "TABLE";
Query OK, 0 rows affected (0.01 sec)

(root@localhost) [test_db]> show global variables like "log_output";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_output    | TABLE |
+---------------+-------+
1 row in set (0.00 sec)

(root@localhost) [test_db]> set global general_log = 1;
Query OK, 0 rows affected (0.03 sec)

############################ Terminal2 ############################
[root@teleport ~]# mysqldump -uroot -hlocalhost -p --single-transaction --master-data=1 test_db > ./test_db.sql
Enter password:

############################ Terminal1 ############################
(root@localhost) [test_db]> set global general_log = 0;
Query OK, 0 rows affected (0.00 sec)

(root@localhost) [test_db]> use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
(root@localhost) [mysql]> select event_time, thread_id, left(argument,64) from general_log where event_time >= "2020-09-14";
+----------------------------+-----------+------------------------------------------------------------------+
| event_time                 | thread_id | left(argument,64)                                                |
+----------------------------+-----------+------------------------------------------------------------------+
| 2020-09-14 15:04:31.128495 |     79088 | (SELECT v_vehicleinfo.VEHICLE_ID, v_vehicleinfo.ID_NUMBER,       |
| 2020-09-14 15:04:35.204935 |     95962 | root@localhost on  using Socket                                  |
| 2020-09-14 15:04:35.205335 |     95962 | /*!40100 SET @@SQL_MODE='' */                                    |
| 2020-09-14 15:04:35.205531 |     95962 | /*!40103 SET TIME_ZONE='+00:00' */                               |
| 2020-09-14 07:04:35.205770 |     95962 | FLUSH /*!40101 LOCAL */ TABLES                                   |
| 2020-09-14 07:04:35.223646 |     95962 | FLUSH TABLES WITH READ LOCK                                      |
| 2020-09-14 07:04:35.298937 |     95962 | SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ          |
| 2020-09-14 07:04:35.681965 |     95962 | START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */           |
| 2020-09-14 07:04:35.682248 |     95962 | SHOW VARIABLES LIKE 'gtid\_mode'                                 |
| 2020-09-14 07:04:35.683298 |     95962 | SHOW MASTER STATUS                                               |
| 2020-09-14 07:04:35.683588 |     95962 | UNLOCK TABLES                                                    |
| 2020-09-14 07:04:35.683985 |     95962 | SELECT LOGFILE_GROUP_NAME, FILE_NAME, TOTAL_EXTENTS, INITIAL_SIZ |
| 2020-09-14 07:04:35.687827 |     95962 | SELECT DISTINCT TABLESPACE_NAME, FILE_NAME, LOGFILE_GROUP_NAME,  |
| 2020-09-14 07:04:35.689806 |     95962 | SHOW VARIABLES LIKE 'ndbinfo\_version'                           |
| 2020-09-14 07:04:35.690858 |     95962 | test_db                                                          |
| 2020-09-14 07:04:35.691016 |     95962 | SAVEPOINT sp                                                     |
| 2020-09-14 07:04:35.691140 |     95962 | show tables                                                      |
| 2020-09-14 07:04:35.691424 |     95962 | show table status like 't1'                                      |
| 2020-09-14 07:04:35.691822 |     95962 | SET SQL_QUOTE_SHOW_CREATE=1                                      |
| 2020-09-14 07:04:35.691986 |     95962 | SET SESSION character_set_results = 'binary'                     |
| 2020-09-14 07:04:35.692109 |     95962 | show create table `t1`                                           |
| 2020-09-14 07:04:35.692267 |     95962 | SET SESSION character_set_results = 'utf8'                       |
| 2020-09-14 07:04:35.692429 |     95962 | show fields from `t1`                                            |
| 2020-09-14 07:04:35.693172 |     95962 | show fields from `t1`                                            |
| 2020-09-14 07:04:35.693865 |     95962 | SELECT /*!40001 SQL_NO_CACHE */ * FROM `t1`                      |
| 2020-09-14 07:04:35.694283 |     95962 | SET SESSION character_set_results = 'binary'                     |
| 2020-09-14 07:04:35.694436 |     95962 | use `test_db`                                                    |
| 2020-09-14 07:04:35.694584 |     95962 | select @@collation_database                                      |
| 2020-09-14 07:04:35.694771 |     95962 | SHOW TRIGGERS LIKE 't1'                                          |
| 2020-09-14 07:04:35.695357 |     95962 | SET SESSION character_set_results = 'utf8'                       |
| 2020-09-14 07:04:35.695539 |     95962 | ROLLBACK TO SAVEPOINT sp                                         |
| 2020-09-14 07:04:35.695658 |     95962 | RELEASE SAVEPOINT sp                                             |
| 2020-09-14 15:04:35.720660 |     91432 | select count(*) from s_post_query a LEFT JOIN b_regulato         |
| 2020-09-14 07:04:35.774251 |     95962 |                                                                  |
| 2020-09-14 15:04:36.350386 |     79088 | SELECT v_vehicleinfo.VEHICLE_ID, v_vehicleinfo.ID_NUMBER as plat |
| 2020-09-14 15:04:36.407790 |     95821 | SELECT te.TERMINAL_CODE terminalCode, vv.ID_NUMBER idNumber, vv. |
| 2020-09-14 15:04:36.431706 |     95821 | SELECT @@session.transaction_read_only                           |
| 2020-09-14 15:04:36.432436 |     95821 | INSERT INTO s_operation_log  ( opera_desc, org_name, sys_type, m |
| 2020-09-14 15:04:36.894190 |     95821 | SELECT TERMINAL_ID,add_channels,terminalname,modifier,ttype_id,r |
| 2020-09-14 15:04:36.899134 |     95821 | SELECT @@session.transaction_read_only                           |
| 2020-09-14 15:04:36.899686 |     95821 | INSERT INTO s_operation_log  ( opera_desc, org_name, sys_type, m |
| 2020-09-14 15:04:37.160447 |     79089 | SELECT v_vehicleinfo.VEHICLE_ID, v_vehicleinfo.ID_NUMBER as plat |
| 2020-09-14 15:04:39.166237 |     79090 | (SELECT v_vehicleinfo.VEHICLE_ID, b_speed_alarm_param.ALARM_SP   |
| 2020-09-14 15:04:39.581187 |     79090 | (SELECT v_vehicleinfo.VEHICLE_ID, b_speed_alarm_param.ALARM_SP   |
| 2020-09-14 15:04:39.678278 |     95949 | set global general_log=0                                         |
+----------------------------+-----------+------------------------------------------------------------------+
45 rows in set (0.01 sec)
```



一致性备份需要使用“--single-transaction”选项；在开始备份之前执行了如下操作：

1. 在开始备份之前执行“FLUSH TABLES WITH READ LOCK”即可对所有表加上一个读锁；
2. 执行“SHOW MASTER STATUS”即可查看到当前数据库的二进制日志所在的位置；
3. 设置事务隔离级别为“REPEATABLE READ”；
4. 开启一个事务；
5. 设置一个保存点sp；
6. 开始导出一个表中的数据；
7. 这个表中的数据导出完成后则立即回滚至保存点sp；
8. 开始备份下一个表；
9. 导出第二个表中的数据后立即回滚至保存点sp。

# mysql备份工具——mysqlpump

mysqlpump是mysql提供的多线程备份工具。

## 语法格式

```
mysqlpump [OPTIONS] --single-transaction [--all-databases]
mysqlpump [OPTIONS] --single-transaction --databases DB1 [DB2 DB3...]
mysqlpump [OPTIONS] --single-transaction database [tables]
```

OPTIONS：

```
--default-parallelism=#：指定队列的线程数，而默认的队列的线程数为2。
--parallel-schemas=name：为哪个数据库指定一个备份的队列。
-C, --compress：对导出的数据进行压缩。
--compress-output=name：默认使用LZ4进行压缩，除LZ4还可使用ZLIB算法进行压缩（经过压缩后的备份文件需要使用zlib_decompress或lz4_decompress解压后再进行数据恢复）。
--ignore-table=db_name.tbl_name：用于指定不导出的表有哪些，如需要指定多张表可多次使用该选项。
```

mysqlpump会有一个默认队列，每个队列会有多个队列用于备份数据库或数据库下面的表，mysqlpump可以针对每个库绑定一个队列并且在每个队列下可配置多个线程从而实现多线程备份的功能。

## 使用示例

```
# 使用mysqlpump备份tpcc库和dbt3库，两个库各自启用一个队列，tpcc的库使用4个线程，dbt3的库使用2个线程

mysqlpump --single-transaction --parallel-schemas=4:tpcc --parallel-schemas=2:dbt3 -B tpcc dbt3 > ./backup_tpcc_dbt3.sql
```

使用mysqlpump备份出来的逻辑数据会在数据导入完成后再创建从而提高数据恢复的效率。

mysqlpump备份的一致性：

1.

# mysql第三方备份工具——xtrabackup

xtrabackup包含两个命令

* xtrabackup：只能备份InnoDB存储引擎（一般不会使用）；
* innobackup：能备份其他存储引擎。

默认需要读取mysql的配置文件。xtrabackup读取my.cnf的顺序是/etc/my.cnf、/etc/mysql/my.cnf、/usr/local/etc/my.cnf、~/.my.cnf。

**xtrabackup只备份InnoDB数据文件，表结构是不备份的，所以恢复的时候，你必须有对应表结构文件(.frm)。**

## 语法

```
xtrabackup [--defaults-file=#] --backup [OPTIONS]
xtrabackup [--defaults-file=#] --prepare [OPTIONS]
```

OPTIONS：

```
--apply-log：通过应用同一目录下的事务日志文件xtrabackup_logfile，在BACKUP-DIR目录中准备一个备份。也建立一个新的事务日志文件。InnoDB的配置是从innobackupex备份时建立的文件backup-my.cnf中读取的。
--compact：备份时忽略二级索引的简单备份。
--compress：对备份后的文件进行压缩（扩展名一般为.qp）。
--compres-threads=#：指定并行压缩时进程的数量，用于提高压缩效率。
--copy-back：使用备份出来的数据进行数据恢复（在执行数据恢复将需要使用--apply-log进行数据恢复前的准备）。
--decompress：解压使用“--compress”选项备份的文件，使用“--parallel”允许多个文件同时被解密或解压。
--print-defaults：打印默认选项。
--no-defaults：忽略所有my.cnf文件。
--defaults-file=#：仅读取指定的my.cnf文件。
--defaults-extra-file=#：除“--defaults-file=”指定要读取的配置文件件另外需要读取的配置文件。
--decrypt=ENCRPYTION-ALGORITHM：解密使用“--encrpyt”选项加密的以“.xbcrypt”结尾的文件。
--encrypt=ENCRYPTION-ALGORITHM：该选项用于使用“ENCRYPTION-ALGORITHM”算法加密InnoDB数据文件的备份。
--encrypt-key=ENCRYPTION_KEY：指定使用“--encrypt＝XXX”加密时的密码。
--encrypt-key-file=ENCRYPTION_KEY_FILE：当使用“--encrypt=XXX”加密时使用存储在“NCRYPTION_KEY_FILE”文件中的加密key。
--encrypt-threads=#：指定加密时的线程数。
--export：用于导出单个表用于导入另一数据库服务器中。
--rebuild-threas=#：在执行“--apply-log”或“--rebuild-indexes”时才有用，该选项用于使用多线程处理表空间文件。
--rsync：使用rsync工具优化本地文件传输；使得备份时使用rsync复制所有非InnoDB文件，而不是使用多个cp。
--slave-info：当备份一个复制从库的时候使用，可用于打印二进制日志的position和主库的名字，将这些信息写入xtrabackup_slave_info文件作为一个CHANGE_MASTER命令。
--backup：实施备份到“target-dir”。
--prepare：实施对备份文件进行恢复前的准备（生成 InnoDB log file）。
--use-memory=#：该参数在 prepare 的时候使用，控制 prepare 时 innodb 实例使用的内存量。
--suspend-at-end：在 target-dir 目录下产生一个 xtrabackup_suspended 文件，将 xtrabackup 进程挂起，不停地将数据文件的变化同步到备份文件，直到用户手工删除 xtrabackup_suspended 文件。
--throttle=#：每秒IO次数,限制 backup 时使用的 I/O 操作量，使备份对数据库正常业务的影响最小化。
--log-stream：该参数在 backup 的时候使用，将 xtrabackup_logfile 的内容输出到标准输出，使用该参数时会自动使用–suspend-at-end 参数，innobackupex 脚本的–stream 模式会使用该参数。
--extra-lsndir=name：仅适用于backup，保存另一份xtrabackup_checkpoints文件
--incremental-lsn=name：增量备份时只拷贝 LSN比该参数指定值新的 ibd pages，前次备份到了哪个 LSN可以看前次备份集的xtrabackup_checkpoints 文件；仅适用于backup，增量备份。
--incremental-basedir=name：该参数在 backup 的时候使用，备份比该参数指定位置的备份集新的 idb pages；仅适用于backup，增量备份目录。
--incremental-dir=name：该参数在 prepare 的时候使用，指定 prepare 时产生的.delta 文件和日志文件的存放路径；仅适用于prepare，恢复指定目录下的.delta文件和日志文件。
--tables=name：在备份 file-per-table 类型的数据文件时使用，使用正则表达式指定需要备份的 innodb 表。
--tables_file=name：过滤database.table列表文件
--datadir=name：MySQL 数据库的数据文件目录。
--no-timestamp：备份是不产生带时间戳的目录。
--parallel=#：开启多个子进程并发备份多个数据文件（注意，一个数据文件只会有一个进程完成备份）；可用于加快备份速度，但在资源紧张时谨慎使用。
```



![](https://images2018.cnblogs.com/blog/1349539/201807/1349539-20180727165438283-1118004015.png)

# mysql客户端命令——mysql

## 语法格式

```
mysql [OPTIONS] [database]
```

## options

--ssh-mode=：指定SSL会话的模式，可用的模式为'DISABLED','PREFERRED','REQUIRED','VERIFY_CA','VERIFY_IDENTITY'。

--ssl-cert=：指定在'VERIFY_CA'的会话模式下指定客户端证书。

--ssl-key=：指定在'VERIFY_CA'的会话模式下指定客户端私钥。

# mysql客户端配置命令——mysql_config_editor

该工具出现在mysql5.6.6以后的版本，可以给指定的连接和密码生成一个加密文件.mylogin.cnf，默认位于当前用户家目录下。通过该文件可以使用mysql、mysqladmin等直接登录，避免明文密码出现在脚本中。

通过mysql_config_editor生成的配置文件保存为二进制格式，即便使用print进行显示也不会将密码打印出来。

## mysql_config_editor命令语法

语法格式：

```
mysql_config_editor [program options] [command [command options]]
```

该命令使用子命令的模式进行操作，不同的子命令有不同的选项。

Command：

```
set [command options]：设置登陆的用户名/密码/主机名/套接字地址/端口等登陆信息。
remove [command options]：从登录文件中删除登录路径。
print [command options]：打印指定登录路径的所有选项。
reset [command options]：删除登陆文件的内容。
help：显示用法和帮助信息。
```

set和remove子命令可用的options：

```
-？，--help：显示帮助信息。
-h, --host=name：指定要连接的数据库的主机名。
-G, --login-path=name：指定标签名，在一个“.mylogin.cnf”文件中可保存多个连接信息。
-p, --password：指定密码。
-u, --user=name：指定用户名。
-S, --socket=name：指定套接字在路径。
-P, --port：指定连接端口。
-w, --warn：
--variable-name=value：指定变量名及其对应的值。

常用变量：
  host：指定服务器端ip或主机名。
  login-path：用于指定配置的标签属性，默认值为“client”。
  user：指定登陆的用户名。
  socket：指定socket文件的绝对路径。
  port：指定服务器端的端口号。
  warn：默认值为“TRUE”。
```

print子命令可用的options：

```
--all：用于查看所有标签的登陆信息。
-?, --help：显示帮助信息。
-G, --login-path=name：指定标签名，用于查看指定的标签的相关信息。

常用变量：
	all：用于定义是否查看所有标签的配置信息，默认为“FALSE”。
	login-path：指定要查看的标签，默认为“client”。
```



## 使用示例

1. 将本机的数据库连接写入到.mylogin.cnf中并使用mysql免密码登陆。

   ```
   # mysql_config_editor set -G local_mysql5.6 -S /database/mysql5.6/run/mysqld.sock -u root -p
   # mysql_config_editor print --all
   # mysql --login-path=local_mysql5.6
   ```

# mysql测试工具——mysqlslap

# mysql表结构查看工具——mysqlfrm

```
# mysqlfrm --diagnostic tb0.frm
    # WARNING: Cannot generate character set or collation names without the --server option.
    # CAUTION: The diagnostic mode is a best-effort parse of the .frm file. As such, it may not identify all of the components of the table correctly. This is especially true for damaged files. It will also not read the default values for the columns and the resulting statement may not be syntactically correct.
    # Reading .frm file for tb0.frm:
    # The .frm file is a TABLE.
    # CREATE TABLE Statement:

    CREATE TABLE `tb0` (
      `id` int(11) NOT NULL
    ) ENGINE=InnoDB;

    #...done.
```

# mysql一致性校验工具——mysqldiff

# mysql一致性校验工具——mysqldbcompare

# mysql一致性校验工具——pt-table-checksum

# mysql慢查询日志查看工具——mysqldumpslow

mysqldumpslow可将慢查询日志中同一类型的sql进行合并后展示出来。

## 语法

mysqldumpslow [ OPTS... ] [ LOGS... ]

可用参数：

```
--verbose：显示mysqld的启动参数；
--debug：
--help：显示命令帮助信息；
-v：显示mysqld的启动参数；
-d
-s ORDER：定义排序规则，默认为at并以降序排序。
	al：平均持锁时长；
	ar：平均返回给客户端的行数；
	at：平均查询时长；
	c：同类型的SQL查询数量；
	l：持锁时长；
	r：返回给客户端的行数；
	t：查询时间；
-r：对排序规则进行逆向排序即升序排序。
-t NUM：仅显示top N的查询。
-a：
-n NUM：
-g PATTERN：
-h
-i
-l
```



## 示例

```
# mysqldumpslow mysql.slow

Count: 1  Time=15.00s (15s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost
  select * from tb0 where sleep(N)

Count: 4  Time=3.75s (15s)  Lock=0.00s (0s)  Rows=1.0 (4), root[root]@localhost
  select sleep(N)
```

Count：表示同类型的SQL数量；

Time：表示平均查询时间；

（15s）：同类型的SQL查询总时长；

Lock：平均持锁时长；

（0s）：持锁总时长；

Rows：平均返回给客户端的行数；

（4）：返回给客户端的总行数；

该命令可将慢查询日志进行格式化后展示出来。



线上业务慢查询日志分析：

```
shell> tail -10000 mysql.slow | mysqldumpslow
```

线上的库如果很慢则会导致慢查询日志增长很快，因此不建议使用mysqldumpslow扫整个慢查日志文件。

# mysql二进制日志查看工具——mysqlbinlog

mysql的二进制日志一般会保存为一下二进制格式的数据文件，无法通过系统自带的文本查看的工具进行解读，因此对于二进制日志的查看一般使用mysqlbinlog命令进行查看。

## 语法

mysqlbinlog [options] log-files

可用参数：

```
-d, --database=name：仅查看指定库的二进制日志内容；
--no-defaults：
--start-datetime=name：指定查看范围内的二进制日志的时间起点；
-j, --start-position=#：指定查看范围内的二进制日志的起点位置；
--stop-datetime=name：指定查看范围内的二进制日志的时间终点；
--stop-position=#：指定查看范围的二进制日志的终点；
-v, --verbose：将sql语句解析出来以便查看。
```



