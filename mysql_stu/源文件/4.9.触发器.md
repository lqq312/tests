[TOC]

# 触发器

触发器的属性定义：

1. 一触即发。
2. 当表上出现特定的事件时触发该程序执行。
3. UPDATE/DELETE/INSERT。
4. 操作触发器的用户必需要有“TRIGGER”的权限。
5. 由于MySQL无法单独设置约束检查，因此触发器也可用于数据的检查。

## 触发器的语法

```
CREATE
    [DEFINER = { user | CURRENT_USER }]
    TRIGGER trigger_name
    trigger_time trigger_event
    ON tbl_name FOR EACH ROW
    [trigger_order]
    trigger_body

trigger_time: { BEFORE | AFTER }

trigger_event: { INSERT | UPDATE | DELETE }

trigger_order: { FOLLOWS | PRECEDES } other_trigger_name
```

触发器的使用总结：

1. 触发器对性能有损耗，应当谨慎使用。
2. 对于事务表，触发器执行失败则整个语句回滚。
3. ROW格式主从复制，触发器不会在从库上执行。
4. 使用触发器时应防止递归执行。

## 触发条件
在MySQL 5.6中同一类型的触发器只能有一个，在MySQL 5.7中允许多个同一类型的触发器。

>* trigger_evevt: {INSERT | UPDATE | DELETE}：用于定义在哪些操作时会触发触发器。
>  * INSERT：在执行“INSERT”、“LOAD DATA”和“REPLACE”的操作时会触发“INSERT”类型的触发器。
>  * UPDATE：仅在执行“UPDATE”的操作才会触发“UPDATE”的触发器。
>  * DELETE：在执行“DELETE”和“REPLACE”的操作时会触发“DELETE”触发器。


注意：

1. “REPLACE”不是标准语句，因此一条“REPLACE”语句会同时触发“DELETE”和“INSERT”类型的触发器。
2. “DROP TABLE”，“TRUNCATE TABLE”和“DROP A PARTITION”都不会触发触发器的执行。

在OSC（即DDL ONLine）需要对指定表创建触发器，在MySQL 5.6上如果这个表上已经有触发器了，则无法再用OSC功能，MySQL 5.7支持多个同一类型的触发器就可以实现DDL ONline。

## 示例
```
mysql> CREATE TABLE stu (
    -> NAME VARCHAR ( 50 ),
    -> course VARCHAR ( 50 ),
    -> score INT ( 11 ),
    -> PRIMARY KEY ( NAME )) ENGINE = INNODB;
mysql> DELIMITER //
mysql> CREATE TRIGGER trg_insert_stu BEFORE INSERT ON stu FOR EACH ROW
    -> BEGIN
    -> IF NEW.score < 0 THEN
    -> SET NEW.score = 0;
    -> ELSEIF NEW.score > 100 THEN
    -> SET NEW.score = 100;
    -> END IF;
    -> END //
mysql> DELIMITER ;
mysql> SHOW TRIGGERS\G
    *************************** 1. row ***************************
                 Trigger: trg_insert_stu
                   Event: INSERT
                   Table: stu
               Statement: BEGIN
    IF NEW.score < 0 THEN
    SET NEW.score = 0;
    ELSEIF NEW.score > 100 THEN
    SET NEW.score = 100;
    END IF;
    END
                  Timing: BEFORE
                 Created: 2019-08-07 16:03:41.86
                sql_mode: ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
                 Definer: admin@192.168.%
    character_set_client: utf8
    collation_connection: utf8_general_ci
      Database Collation: utf8mb4_general_ci
mysql> INSERT INTO stu SELECT "David","Math",150;
mysql> SELECT * FROM stu;
    +-------+--------+-------+
    | NAME  | course | score |
    +-------+--------+-------+
    | David | Math   |   100 |
    +-------+--------+-------+
```

>NEW.col_name：更新以后的列值。
>
>OLD.col_name：更新前的列值（只读）。

* 触发器对性能有损耗，应用慎重使用；
* 对于事务表，触发器执行失败则整个语句回滚；
* Row格式主从复制，触发器不会在从库上执行；
* 使用触发器时应防止递归执行。